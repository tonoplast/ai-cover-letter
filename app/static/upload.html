<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Cover Letter Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            min-height: 100vh;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .upload-area {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
            background-color: #fafafa;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .file-list {
            margin: 20px 0;
        }
        .file-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 5px 0;
            background-color: #f9f9f9;
        }
        .file-item select {
            margin-left: 10px;
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        .file-item .remove-btn {
            margin-left: auto;
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group textarea {
            height: 120px;
            resize: vertical;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .instructions {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #0056b3;
        }
        .instructions ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .cover-letter-preview {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }
        .company-info {
            background-color: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            background-color: #f8f9fa;
        }
        .tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Chat Interface Styles */
        .chat-container {
            display: flex;
            height: 1200px;
            min-height: 800px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .chat-sidebar {
            width: 300px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            padding: 15px;
            overflow-y: auto;
        }
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            min-height: 0;
            height: 100%;
            position: relative;
        }
        .cover-letters-panel {
            display: flex;
            height: 65%;
            min-height: 450px;
            border-bottom: 1px solid #ddd;
        }
        .cover-letter-section {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        .cover-letter-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
        }
        .cover-letter-content {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            font-family: Arial, sans-serif;
            line-height: 1.6;
            white-space: pre-wrap;
            font-size: 15px;
            height: calc(100% - 50px);
            overflow-y: auto;
        }
        .cover-letter-divider {
            width: 2px;
            background-color: #ddd;
        }
        .chat-messages {
            flex: 1 1 auto;
            padding: 24px;
            overflow-y: auto;
            background-color: white;
            min-height: 300px;
            font-size: 15px;
        }
        .chat-input-area {
            padding: 24px;
            border-top: 1px solid #ddd;
            background-color: #f8f9fa;
            position: relative;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .chat-llm-settings {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        .message.user {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }
        .message.assistant {
            background-color: #e9ecef;
            color: #333;
        }
        .cover-letter-item {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 8px;
            cursor: pointer;
            background-color: white;
            font-size: 14px;
        }
        .cover-letter-item:hover {
            background-color: #e3f2fd;
        }
        .cover-letter-item.active {
            background-color: #007bff;
            color: white;
        }
        .cover-letter-item strong {
            display: block;
            font-size: 16px;
            margin-bottom: 4px;
            font-weight: bold;
        }
        .cover-letter-item small {
            display: block;
            opacity: 0.8;
            line-height: 1.3;
            font-size: 13px;
        }
        .chat-input {
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .chat-input button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background-color: #0056b3;
        }
        .chat-input button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .export-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        .export-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .export-pdf {
            background-color: #dc3545;
            color: white;
        }
        .export-docx {
            background-color: #28a745;
            color: white;
        }
        .export-txt {
            background-color: #17a2b8;
            color: white;
        }
        
        /* Database selective deletion styles */
        .database-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 5px 0;
            background-color: white;
        }
        .database-item:hover {
            background-color: #f8f9fa;
        }
        .database-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .database-item-content {
            flex: 1;
        }
        .database-item-actions {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }
        .delete-item-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .delete-item-btn:hover {
            background-color: #c82333;
        }
        .select-all-container {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            align-items: center;
        }
        .select-all-container label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
        }
        .select-all-container input[type="checkbox"] {
            margin: 0;
        }
        
        /* Collapsible sections styles */
        .collapsible-section {
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .collapsible-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background 0.3s ease;
        }
        .collapsible-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .collapsible-header .section-icon {
            font-size: 18px;
            margin-right: 10px;
        }
        .collapsible-header .section-count {
            font-size: 14px;
            font-weight: bold;
            color: #007bff;
            margin-left: 8px;
            display: inline-block;
            min-width: 32px;
            text-align: right;
            background: none;
            border-radius: 0;
            padding: 0;
        }
        .collapsible-header .toggle-icon {
            font-size: 16px;
            transition: transform 0.3s ease;
            display: inline-block;
        }
        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        .collapsible-header .toggle-icon {
            transform: rotate(0deg);
        }
        .collapsible-content {
            max-height: 600px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
            background: white;
        }
        .collapsible-content.collapsed {
            max-height: 0;
            overflow: hidden;
        }
        .collapsible-content .section-items {
            padding: 15px;
        }
        
        /* Custom scrollbar styling */
        .collapsible-content::-webkit-scrollbar {
            width: 8px;
        }
        .collapsible-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .collapsible-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        .collapsible-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        .scroll-indicator {
            text-align: center;
            padding: 10px;
            color: #6c757d;
            font-style: italic;
            border-top: 1px solid #e9ecef;
            margin-top: 10px;
        }
        
        /* Search and filter styles */
        .database-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .search-filter-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-dropdown {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        .view-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .view-toggle button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        .view-toggle button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .view-toggle button:hover {
            background: #f8f9fa;
        }
        .view-toggle button.active:hover {
            background: #0056b3;
        }
        
        /* Compact view styles */
        .database-item.compact {
            padding: 6px 10px;
            font-size: 13px;
        }
        .database-item.compact .database-item-content {
            font-size: 13px;
        }
        .database-item.compact .database-item-actions button {
            padding: 3px 8px;
            font-size: 11px;
        }
        .database-item.compact .database-item-actions input {
            width: 50px;
            font-size: 10px;
            padding: 1px 2px;
        }
        .database-item.compact .database-item-actions label {
            font-size: 10px;
        }
        
        /* Empty state styles */
        .empty-section {
            padding: 30px;
            text-align: center;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 10px 0;
        }
        .empty-section .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .bulk-actions {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .save-options {
            margin-top: 15px;
            padding: 10px;
            background-color: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 5px;
            display: none;
        }
        .save-options h5 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #155724;
        }
        .save-buttons {
            display: flex;
            gap: 10px;
        }
        .save-overwrite {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-overwrite:hover {
            background-color: #218838;
        }
        .save-new {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .save-new:hover {
            background-color: #138496;
        }
        /* Diff highlighting styles */
        .diff-added {
            background-color: #d4edda;
            color: #155724;
            padding: 2px 4px;
            border-radius: 3px;
            text-decoration: none;
            margin: 1px 0;
            border-left: 3px solid #28a745;
        }
        .diff-removed {
            background-color: #f8d7da;
            color: #721c24;
            padding: 2px 4px;
            border-radius: 3px;
            text-decoration: line-through;
            margin: 1px 0;
            border-left: 3px solid #dc3545;
        }
        .diff-unchanged {
            background-color: transparent;
            color: #333;
            padding: 2px 4px;
            margin: 1px 0;
            border-left: 3px solid transparent;
        }
        .diff-changed {
            background-color: #fff3cd;
            color: #856404;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .no-changes-message {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6c757d;
            font-style: italic;
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }
        .diff-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .diff-toggle {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .diff-toggle:hover {
            background-color: #0056b3;
        }
        .diff-toggle.active {
            background-color: #28a745;
        }
        .revised-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }
        .revised-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            background-color: #f8f9fa;
        }
        .revised-tab.revised-tab-active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
        .modal-body {
            padding: 20px;
        }
        .data-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .data-section h4 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        .data-field {
            margin-bottom: 10px;
        }
        .data-field label {
            font-weight: bold;
            color: #555;
            display: block;
            margin-bottom: 3px;
        }
        .data-field .value {
            background-color: white;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .data-field .value.json {
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .view-item-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 5px;
        }
        .view-item-btn:hover {
            background: #138496;
        }
        .chat-main.save-popup-active {
            padding-bottom: 120px; /* Enough space for the popup */
            transition: padding-bottom 0.2s;
        }
        @media (max-width: 1200px) {
            .container { 
                margin: 0 10px;
                padding: 20px;
                min-height: 90vh;
            }
            .chat-container { 
                height: 600px; 
                min-height: 500px; 
            }
        }
        .generation-form { display: none; }
        .generation-form.active { display: block; }
        .generation-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            background: #f4f7fa;
            border: 1px solid #e0e0e0;
            width: fit-content;
        }
        .generation-tab {
            flex: 1 1 0;
            padding: 18px 36px;
            font-size: 18px;
            font-weight: 600;
            color: #555;
            background: #f4f7fa;
            border: none;
            outline: none;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            border-right: 1px solid #e0e0e0;
            border-radius: 0;
        }
        .generation-tab:last-child {
            border-right: none;
        }
        .generation-tab.active {
            background: #fff;
            color: #007bff;
            box-shadow: 0 4px 16px rgba(0,123,255,0.08);
            z-index: 1;
            border-bottom: 2px solid #007bff;
        }
        .generation-tab:not(.active):hover {
            background: #e9f2fb;
            color: #0056b3;
        }
        @media (max-width: 700px) {
            .generation-tabs { flex-direction: column; width: 100%; }
            .generation-tab { width: 100%; border-right: none; border-bottom: 1px solid #e0e0e0; }
            .generation-tab:last-child { border-bottom: none; }
        }
        .section-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 32px;
            align-items: center;
            margin-bottom: 16px;
        }
        .section-summary p {
            margin: 0;
            display: flex;
            align-items: center;
            font-size: 16px;
            min-width: 220px;
            justify-content: space-between;
        }
        .section-summary .summary-label {
            flex: 1 1 auto;
            text-align: left;
            padding-right: 8px;
        }
        .section-summary .summary-count, .collapsible-header .section-count {
            flex: 0 0 40px;
            text-align: right;
            font-variant-numeric: tabular-nums;
            font-weight: bold;
            color: #007bff;
            margin-left: 8px;
            display: inline-block;
            min-width: 32px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🤖 AI Cover Letter Generator</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('upload')">📁 Upload Documents</div>
            <div class="tab" onclick="showTab('generate')">✍️ Generate Cover Letter</div>
            <div class="tab" onclick="showTab('chat')">💬 Chat & Edit</div>
            <div class="tab" onclick="showTab('database')">📊 Database</div>
        </div>

        <!-- Upload Documents Tab -->
        <div id="upload-tab" class="tab-content active">
            <div class="instructions">
                <h3>📋 Upload Instructions</h3>
                <ul>
                    <li><strong>Document Recency:</strong> The most recently uploaded document is considered most relevant for AI context extraction. Upload order does not affect relevance.</li>
                    <li><strong>Supported Formats:</strong> PDF, DOCX, TXT, CSV, XLSX</li>
                    <li><strong>Document Types:</strong> CV, Cover Letter, LinkedIn, or Other</li>
                    <li><strong>Multiple Files:</strong> Drag & drop or select multiple files at once</li>
                </ul>
            </div>

            <div class="upload-area" id="uploadArea">
                <h3>📁 Drag & Drop Files Here</h3>
                <p>or</p>
                <input type="file" id="fileInput" multiple style="display: none;">
                <button class="btn" onclick="document.getElementById('fileInput').click()">Select Files</button>
                <button class="btn" id="clearSelectionBtn" onclick="clearFileSelection()">Clear Selection</button>
            </div>

            <!-- Bulk type set buttons -->
            <div id="bulkTypeButtons" style="margin: 10px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" type="button" onclick="setAllFileTypes('cv')">Set All to CV/Resume</button>
                <button class="btn btn-success" type="button" onclick="setAllFileTypes('cover_letter')">Set All to Cover Letter</button>
                <button class="btn btn-success" type="button" onclick="setAllFileTypes('linkedin')">Set All to LinkedIn</button>
                <button class="btn btn-success" type="button" onclick="setAllFileTypes('other')">Set All to Other</button>
            </div>

            <div id="fileList" class="file-list"></div>
            <div id="uploadResults" class="file-list"></div>

            <div class="section">
                <h3>🔧 Document Processing Options</h3>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="useLLMExtraction" style="width: auto; margin: 0;">
                        Use AI for Enhanced Document Parsing
                    </label>
                    <small style="color: #666;">When enabled, AI will extract structured information (experiences, education, skills) from your documents. When disabled, uses basic text extraction only.</small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="extractImages" style="width: auto; margin: 0;">
                        Extract Text from Images in PDFs
                    </label>
                    <small style="color: #666;">When enabled, the system will extract text from images in PDFs using OCR. This can capture tools, software, and other content that appears as images.</small>
                </div>
                <div class="form-group" id="uploadLLMProviderGroup" style="display: none;">
                    <label for="uploadLlmProvider">AI Model Provider:</label>
                    <select id="uploadLlmProvider" onchange="loadLLMModels(this.value, 'uploadLlmModel', 'uploadLLMModelGroup')">
                        <option value="">Auto (Use Default: Ollama)</option>
                        <option value="ollama">Ollama (Local)</option>
                        <option value="openai">OpenAI</option>
                        <option value="anthropic">Anthropic Claude</option>
                        <option value="google">Google Gemini</option>
                    </select>
                    <small style="color: #666;">Select which AI provider to use for document parsing. <b>Auto</b> uses the default configured provider. <b>✅</b> indicates the current default.</small>
                </div>
                <div class="form-group" id="uploadLLMModelGroup" style="display: none;">
                    <label for="uploadLlmModel">AI Model:</label>
                    <select id="uploadLlmModel"></select>
                    <small style="color: #666;">Select a specific model for the chosen provider. <b>Auto</b> uses the default model for the selected provider. <b>(Default)</b> marks the default model.</small>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="enableVisionLlm" name="enableVisionLlm" style="width: auto; margin: 0;" onchange="toggleVisionLlmOptions()">
                        Enable Vision LLM for Logo Recognition
                    </label>
                    <small style="color: #666;">When enabled, the system will use a vision-capable LLM to recognize logos and tools in images (PDFs, DOCX, etc).</small>
                </div>
                <div class="form-group" id="visionLlmProviderGroup" style="display:none;">
                    <label for="visionLlmProvider">Vision LLM Provider:</label>
                    <select id="visionLlmProvider" onchange="loadVisionLLMModels(this.value)"></select>
                    <small style="color: #666;">Select which AI provider to use for vision-based logo recognition. <b>Auto</b> uses the default configured provider. <b>✅</b> indicates the current default.</small>
                </div>
                <div class="form-group" id="visionLlmModelGroup" style="display:none;">
                    <label for="visionLlmModel">Vision LLM Model:</label>
                    <select id="visionLlmModel"></select>
                    <small style="color: #666;">Select a specific model for the chosen provider. <b>Auto</b> uses the default model for the selected provider. <b>(Default)</b> marks the default model.</small>
                </div>
            </div>

            <input type="hidden" id="logoRecognition" name="logoRecognition" value="none">
            <div style="text-align: center;">
                <button class="btn" id="uploadBtn" onclick="uploadFiles()" disabled>Upload All Files</button>
                <button class="btn btn-danger" onclick="clearDatabase()">🗑️ Clear Database</button>
            </div>
        </div>

        <!-- Move Search Provider Information to only show in Generate Cover Letter tab -->
        <div id="search-provider-info-container" style="display: none;">
            <div id="search-provider-info" class="section" style="margin-bottom: 24px;">
                <h3 style="margin-top: 0;">Search Provider Information</h3>
                <div id="searchProviderInfoContent"></div>
            </div>
        </div>

        <!-- Generate Cover Letter Tab -->
        <div id="generate-tab" class="tab-content">
            <div class="section">
                <h2>✍️ Cover Letter Generation</h2>
                <div class="generation-tabs">
                    <button class="generation-tab active" id="singleGenTab" onclick="showGenerationTab('single')">Single Cover Letter</button>
                    <button class="generation-tab" id="batchGenTab" onclick="showGenerationTab('batch')">Batch Cover Letters</button>
                </div>
                <div id="singleGenerationForm" class="generation-form active">
                    <div class="section">
                        <h2>✍️ Single Cover Letter with User Input</h2>
                        <div class="form-group">
                            <label for="jobTitle">Job Title:</label>
                            <input type="text" id="jobTitle" placeholder="e.g., Software Engineer, Data Scientist">
                        </div>
                        <div class="form-group">
                            <label for="companyName">Company Name:</label>
                            <input type="text" id="companyName" placeholder="e.g., Google, Microsoft, etc.">
                        </div>
                        <div class="form-group">
                            <label for="jobDescription">Job Description:</label>
                            <textarea id="jobDescription" placeholder="Paste the job description here..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="tone">Writing Tone:</label>
                            <select id="tone">
                                <option value="professional">Professional</option>
                                <option value="enthusiastic">Enthusiastic</option>
                                <option value="formal">Formal</option>
                                <option value="conversational">Conversational</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="includeCompanyResearch" checked style="width: auto; margin: 0;">
                                Include Company Research
                            </label>
                            <small style="color: #666;">When enabled, the AI will research the company and include relevant information (mission, values, industry) in your cover letter. Only includes information that can be verified.</small>
                        </div>
                        <div class="form-group" id="singleResearchProviderGroup" style="display: none;">
                            <label for="singleSearchProvider">Research Provider:</label>
                            <select id="singleSearchProvider">
                                <option value="">Auto (Best Available)</option>
                                <option value="tavily">Tavily AI (Recommended)</option>
                                <option value="openai">OpenAI</option>
                                <option value="google">Google AI</option>
                                <option value="brave">Brave Search (Privacy-focused)</option>
                                <option value="yacy">YaCy (Self-hosted)</option>
                                <option value="searxng">SearXNG (Self-hosted)</option>
                                <option value="duckduckgo">DuckDuckGo (Free)</option>
                            </select>
                            <small style="color: #666;">Select which search provider to use for company research. Auto will use the best available provider.</small>
                        </div>
                        <div class="form-group" id="singleResearchCountryGroup" style="display: none;">
                            <label for="researchCountry">Research Country (Optional):</label>
                            <select id="researchCountry">
                                <option value="">Global (No country focus)</option>
                                <option value="Australia">Australia</option>
                                <option value="United States">United States</option>
                                <option value="Canada">Canada</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Germany">Germany</option>
                                <option value="France">France</option>
                                <option value="Netherlands">Netherlands</option>
                                <option value="Sweden">Sweden</option>
                                <option value="Norway">Norway</option>
                                <option value="Denmark">Denmark</option>
                                <option value="Finland">Finland</option>
                                <option value="Switzerland">Switzerland</option>
                                <option value="Singapore">Singapore</option>
                                <option value="Japan">Japan</option>
                                <option value="South Korea">South Korea</option>
                                <option value="New Zealand">New Zealand</option>
                                <option value="Ireland">Ireland</option>
                                <option value="Belgium">Belgium</option>
                                <option value="Austria">Austria</option>
                            </select>
                            <small style="color: #666;">Focus search on a specific country for more relevant results. Leave empty for global search.</small>
                        </div>
                        <div class="form-group">
                            <label for="llmProvider">AI Model Provider:</label>
                            <select id="llmProvider">
                                <option value="">Auto (Use Default: Ollama)</option>
                                <option value="ollama">Ollama (Local)</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic Claude</option>
                                <option value="google">Google Gemini</option>
                            </select>
                            <small style="color: #666;">Select which AI provider to use for cover letter generation. Auto uses the default configured provider.</small>
                        </div>
                        <div class="form-group" id="llmModelGroup" style="display: none;">
                            <label for="llmModel">AI Model:</label>
                            <select id="llmModel"></select>
                            <small style="color: #666;">Select a specific model for the chosen provider. <b>Auto</b> uses the default model for the selected provider. <b>(Default)</b> marks the default model.</small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="strictRelevance" checked style="width: auto; margin: 0;">
                                Strictly match job requirements to my experience (recommended)
                            </label>
                            <small style="color: #666;">When enabled, the AI will systematically address each job requirement using your real experience, and will not invent or exaggerate. If unticked, the cover letter may be more general or creative.</small>
                        </div>
                        <button class="btn btn-success" onclick="generateCoverLetter()">🚀 Generate Cover Letter</button>
                        <div id="coverLetterPreview"></div>
                    </div>
                </div>
                <div id="batchGenerationForm" class="generation-form">
                    <div class="section">
                        <h2>🌐 Batch Generate from Job Ad Websites</h2>
                        <div class="form-group">
                            <label for="batchJobTitle">Job Title (optional, used if not found on site):</label>
                            <input type="text" id="batchJobTitle" placeholder="e.g., Software Engineer">
                        </div>
                        <div class="form-group">
                            <label for="batchCompanyName">Company Name (optional, used if not found on site):</label>
                            <input type="text" id="batchCompanyName" placeholder="e.g., Victoria Legal Aid">
                        </div>
                        <div class="form-group">
                            <label for="batchJobDescription">Job Description (optional, used if not found on site):</label>
                            <textarea id="batchJobDescription" placeholder="Paste a default job description..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="batchTone">Writing Tone:</label>
                            <select id="batchTone">
                                <option value="professional">Professional</option>
                                <option value="enthusiastic">Enthusiastic</option>
                                <option value="formal">Formal</option>
                                <option value="conversational">Conversational</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="batchWebsites">Job Ad URLs (one per line):</label>
                            <textarea id="batchWebsites" placeholder="https://jobsite.com/ad1\nhttps://jobsite.com/ad2\n..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="batchDelay">Delay between jobs (seconds):</label>
                            <input type="number" id="batchDelay" value="3" min="1" max="10" style="width: 100px;">
                            <small style="color: #666;">Higher values reduce chance of being blocked, but take longer</small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="batchIncludeCompanyResearch" checked style="width: auto; margin: 0;">
                                Include Company Research (Batch)
                            </label>
                            <small style="color: #666;">When enabled, the AI will research each company and include relevant information in cover letters.</small>
                        </div>
                        <div class="form-group" id="batchResearchProviderGroup" style="display: none;">
                            <label for="batchResearchProvider">Research Provider:</label>
                            <select id="batchResearchProvider">
                                <option value="">Auto (Best Available)</option>
                                <option value="tavily">Tavily AI (Recommended)</option>
                                <option value="openai">OpenAI</option>
                                <option value="google">Google AI</option>
                                <option value="brave">Brave Search (Privacy-focused)</option>
                                <option value="yacy">YaCy (Self-hosted)</option>
                                <option value="searxng">SearXNG (Self-hosted)</option>
                                <option value="duckduckgo">DuckDuckGo (Free)</option>
                            </select>
                            <small style="color: #666;">Select which search provider to use for company research. Auto will use the best available provider.</small>
                        </div>
                        <div class="form-group" id="batchResearchCountryGroup" style="display: none;">
                            <label for="batchResearchCountry">Research Country (Optional):</label>
                            <select id="batchResearchCountry">
                                <option value="">Global (No country focus)</option>
                                <option value="Australia">Australia</option>
                                <option value="United States">United States</option>
                                <option value="Canada">Canada</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Germany">Germany</option>
                                <option value="France">France</option>
                                <option value="Netherlands">Netherlands</option>
                                <option value="Sweden">Sweden</option>
                                <option value="Norway">Norway</option>
                                <option value="Denmark">Denmark</option>
                                <option value="Finland">Finland</option>
                                <option value="Switzerland">Switzerland</option>
                                <option value="Singapore">Singapore</option>
                                <option value="Japan">Japan</option>
                                <option value="South Korea">South Korea</option>
                                <option value="New Zealand">New Zealand</option>
                                <option value="Ireland">Ireland</option>
                                <option value="Belgium">Belgium</option>
                                <option value="Austria">Austria</option>
                            </select>
                            <small style="color: #666;">Focus search on a specific country for more relevant results. Leave empty for global search.</small>
                        </div>
                        <div class="form-group">
                            <label for="batchLlmProvider">AI Model Provider (Batch):</label>
                            <select id="batchLlmProvider">
                                <option value="">Auto (Use Default: Ollama)</option>
                                <option value="ollama">Ollama (Local)</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic Claude</option>
                                <option value="google">Google Gemini</option>
                            </select>
                            <small style="color: #666;">Select which AI provider to use for batch cover letter generation. Auto uses the default configured provider.</small>
                        </div>
                        <div class="form-group" id="batchLlmModelGroup" style="display: none;">
                            <label for="batchLlmModel">AI Model (Batch):</label>
                            <select id="batchLlmModel"></select>
                            <small style="color: #666;">Select a specific model for the chosen provider. <b>Auto</b> uses the default model for the selected provider. <b>(Default)</b> marks the default model.</small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="batchStrictRelevance" checked style="width: auto; margin: 0;">
                                Strictly match job requirements to my experience (recommended)
                            </label>
                            <small style="color: #666;">When enabled, the AI will systematically address each job requirement using your real experience, and will not invent or exaggerate. If unticked, the cover letter may be more general or creative.</small>
                        </div>
                        <button class="btn btn-success" onclick="batchGenerateCoverLetters()">🚀 Batch Generate Cover Letters</button>
                        <div id="batchStatus"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat & Edit Tab -->
        <div id="chat-tab" class="tab-content">
            <div class="section">
                <h2>💬 Chat & Edit Cover Letters</h2>
                <p>Select a cover letter from the sidebar and chat with the AI to make modifications.</p>
                
                <div class="chat-container">
                    <div class="chat-sidebar">
                        <h3>📄 Cover Letters</h3>
                        <div id="coverLetterList"></div>
                    </div>
                    <div class="chat-main">
                        <div class="cover-letters-panel" id="coverLettersPanel" style="display: none;">
                            <div class="cover-letter-section">
                                <h4>📝 Current Version</h4>
                                <div class="cover-letter-content" id="currentCoverLetterContent"></div>
                            </div>
                            <div class="cover-letter-divider"></div>
                            <div class="cover-letter-section">
                                <h4>✏️ Revised Version</h4>
                                <div class="revised-tabs">
                                    <button class="revised-tab revised-tab-active" id="showChangesTab" onclick="toggleDiffView()">Show Changes</button>
                                    <button class="revised-tab" id="editRevisedTab" onclick="switchRevisedTab('edit')">Edit Revised Version</button>
                                </div>
                                <div id="revisedDiffPanel" style="display: block;">
                                    <div class="diff-controls">
                                        <span id="diffStatus">No changes detected</span>
                                    </div>
                                    <div class="cover-letter-content" id="revisedDiffContent" style="background: #fffbe6;"></div>
                                    <div class="no-changes-message" id="noChangesMessage" style="display: none;">
                                        ✨ No changes made - revised version is identical to current version
                                    </div>
                                </div>
                                <div id="revisedEditPanel" style="display: none;">
                                    <div class="cover-letter-content" id="revisedEditContent" contenteditable="true" spellcheck="true" style="outline: 1px solid #007bff; min-height: 200px; background: #fff;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="save-options" id="saveOptions" style="display: none;">
                            <h5>💾 Save Changes</h5>
                            <p id="saveStatus">You have unsaved changes. Choose how to save them:</p>
                            <div class="save-buttons">
                                <button class="save-overwrite" onclick="updateCurrentVersion()">🔄 Update Current Version</button>
                                <button class="save-new" onclick="saveAsNew()">🆕 Save as New</button>
                                <button class="btn" onclick="cancelEdit()">Cancel</button>
                            </div>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <div class="message assistant">
                                👋 Hi! I'm here to help you edit your cover letter. Select a cover letter from the sidebar to get started.
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <div class="chat-llm-settings">
                                <div class="form-group" style="margin-bottom: 10px;">
                                    <label for="chatLlmProvider" style="font-size: 12px; color: #666;">AI Model Provider:</label>
                                    <select id="chatLlmProvider" style="width: 100%; font-size: 12px;">
                                        <option value="">Auto (Use Default: Ollama)</option>
                                        <option value="ollama">Ollama (Local)</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Anthropic Claude</option>
                                        <option value="google">Google Gemini</option>
                                    </select>
                                </div>
                                <div class="form-group" id="chatLlmModelGroup" style="display: none; margin-bottom: 10px;">
                                    <label for="chatLlmModel" style="font-size: 12px; color: #666;">AI Model:</label>
                                    <select id="chatLlmModel"></select>
                                    <small style="color: #666;">Select a specific model for the chosen provider. <b>Auto</b> uses the default model for the selected provider. <b>(Default)</b> marks the default model.</small>
                                </div>
                            </div>
                            <div class="chat-input">
                                <input type="text" id="chatInput" placeholder="Ask me to modify the cover letter..." onkeypress="handleChatKeyPress(event)">
                                <button onclick="sendChatMessage()" id="sendChatBtn">Send</button>
                            </div>
                            <div class="export-buttons" id="exportButtons" style="display: none;">
                                <button class="export-pdf" onclick="exportCurrentLetter('pdf')">📄 Export PDF</button>
                                <button class="export-docx" onclick="exportCurrentLetter('docx')">📝 Export DOCX</button>
                                <button class="export-txt" onclick="exportCurrentLetter('txt')">📄 Export TXT</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Tab -->
        <div id="database-tab" class="tab-content">
            <div class="section">
                <h2>📊 Database Contents</h2>
                <button class="btn" onclick="checkDatabase()">🔄 Refresh Database Status</button>
                <div id="databaseStatus"></div>
                
                <!-- Database Controls -->
                <div class="database-controls">
                    <div class="search-filter-container">
                        <input type="text" id="databaseSearch" class="search-box" placeholder="🔍 Search files, titles, companies..." onkeyup="filterDatabaseItems()">
                        <select id="databaseFilter" class="filter-dropdown" onchange="filterDatabaseItems()">
                            <option value="all">All Items</option>
                            <option value="cv">CV/Resume Only</option>
                            <option value="cover_letters">Generated Cover Letters Only</option>
                            <option value="cover_letter_docs">Uploaded Cover Letters Only</option>
                            <option value="other">Other Documents Only</option>
                            <option value="experience">Experiences Only</option>
                            <option value="company_research">Company Research Only</option>
                        </select>
                        <div class="view-toggle">
                            <button id="viewNormal" class="active" onclick="toggleViewMode('normal')">📋 Normal</button>
                            <button id="viewCompact" onclick="toggleViewMode('compact')">📝 Compact</button>
                        </div>
                    </div>
                    
                    <div class="select-all-container">
                        <label><input type="checkbox" id="selectAllDocuments" onchange="toggleSelectAll('documents')"> All Documents</label>
                        <label><input type="checkbox" id="selectAllCV" onchange="toggleSelectAll('cv')"> All CV/Resume</label>
                        <label><input type="checkbox" id="selectAllCoverLetters" onchange="toggleSelectAll('cover_letters')"> All Generated Cover Letters</label>
                        <label><input type="checkbox" id="selectAllCoverLetterDocs" onchange="toggleSelectAll('cover_letter_docs')"> All Uploaded Cover Letters</label>
                        <label><input type="checkbox" id="selectAllOtherDocuments" onchange="toggleSelectAll('other_documents')"> All Other Documents</label>
                        <label><input type="checkbox" id="selectAllExperiences" onchange="toggleSelectAll('experiences')"> All Experiences</label>
                        <label><input type="checkbox" id="selectAllCompanyResearch" onchange="toggleSelectAll('company_research')"> All Company Research</label>
                    </div>
                    
                    <div class="bulk-actions">
                        <button class="btn btn-danger" onclick="deleteSelectedItems()">🗑️ Delete Selected</button>
                        <button class="btn btn-danger" onclick="clearDatabase()">🗑️ Clear All Database</button>
                        <span id="selectedCount">0 items selected</span>
                    </div>
                </div>
                
                <div id="databaseDetails"></div>
            </div>
        </div>

        <div id="status"></div>
    </div>

    <!-- Data View Modal -->
    <div id="dataModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">View Data</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="modalData"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let databaseData = null;
        let mode = 'normal'; // 'normal', 'edit', 'diff'
        let lastRevisedContent = '';

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');

            // Show/hide search provider info only for generate tab
            document.getElementById('search-provider-info-container').style.display = (tabName === 'generate') ? 'block' : 'none';

            // Load data for specific tabs
            if (tabName === 'database') {
                checkDatabase();
            } else if (tabName === 'chat') {
                loadCoverLetters();
            }
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            addFiles(files);
        });

        function addFiles(files) {
            // Allow duplicate file names by always adding new files
            files.forEach(file => {
                selectedFiles.push(file);
            });
            updateFileList();
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const uploadBtn = document.getElementById('uploadBtn');
            
            if (selectedFiles.length === 0) {
                fileList.innerHTML = '<p>No files selected</p>';
                uploadBtn.disabled = true;
                return;
            }

            fileList.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-item">
                    <span>📄 ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <select id="type-${index}" onchange="handleTypeChange(${index})">
                        <option value="cv">CV/Resume</option>
                        <option value="cover_letter">Cover Letter</option>
                        <option value="linkedin">LinkedIn</option>
                        <option value="other">Other</option>
                    </select>
                    <input type="text" id="linkedin-url-${index}" placeholder="LinkedIn Profile URL" style="display:none; margin-left:10px; width:220px;" />
                    <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
                </div>
            `).join('');

            // Show LinkedIn URL input if needed
            selectedFiles.forEach((file, index) => {
                const typeSelect = document.getElementById(`type-${index}`);
                const urlInput = document.getElementById(`linkedin-url-${index}`);
                if (typeSelect.value === 'linkedin') {
                    urlInput.style.display = 'inline-block';
                } else {
                    urlInput.style.display = 'none';
                }
            });

            uploadBtn.disabled = false;
        }

        function handleTypeChange(index) {
            const typeSelect = document.getElementById(`type-${index}`);
            const urlInput = document.getElementById(`linkedin-url-${index}`);
            if (typeSelect.value === 'linkedin') {
                urlInput.style.display = 'inline-block';
            } else {
                urlInput.style.display = 'none';
            }
        }

        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            const formData = new FormData();
            const documentTypes = [];
            const linkedinUrls = [];

            selectedFiles.forEach((file, index) => {
                formData.append('files', file);
                const typeSelect = document.getElementById(`type-${index}`);
                documentTypes.push(typeSelect.value);
                const urlInput = document.getElementById(`linkedin-url-${index}`);
                linkedinUrls.push(urlInput && typeSelect.value === 'linkedin' ? urlInput.value.trim() : '');
            });

            documentTypes.forEach(type => {
                formData.append('document_types', type);
            });
            linkedinUrls.forEach(url => {
                formData.append('linkedin_urls', url);
            });

            // Add LLM parameters if AI extraction is enabled
            const useLLMExtraction = document.getElementById('useLLMExtraction').checked;
            if (useLLMExtraction) {
                const llmProvider = document.getElementById('uploadLlmProvider').value;
                const llmModel = document.getElementById('uploadLlmModel').value;
                
                if (llmProvider) {
                    formData.append('llm_provider', llmProvider);
                }
                if (llmModel) {
                    formData.append('llm_model', llmModel);
                }
                formData.append('use_llm_extraction', 'true');
            } else {
                formData.append('use_llm_extraction', 'false');
            }

            // Add image extraction parameter
            const extractImages = document.getElementById('extractImages').checked;
            formData.append('extract_images', extractImages ? 'true' : 'false');

            // Add logo recognition parameter
            const logoRecognition = document.getElementById('logoRecognition').value;
            formData.append('logo_recognition', logoRecognition);
            // Add Vision LLM provider/model if vision_llm selected
            if (logoRecognition === 'vision_llm') {
                const visionLlmProvider = document.getElementById('visionLlmProvider').value;
                const visionLlmModel = document.getElementById('visionLlmModel').value;
                formData.append('vision_llm_provider', visionLlmProvider);
                formData.append('vision_llm_model', visionLlmModel);
            }

            showStatus('Uploading files...', 'info');

            try {
                const response = await fetch('/upload-multiple-documents', {
                    method: 'POST',
                    body: formData
                });

                let result = null;
                try {
                    result = await response.json();
                } catch (jsonError) {
                    showStatus('❌ Upload failed: Server error (not JSON)', 'error');
                    return;
                }

                if (response.ok) {
                    showStatus(`✅ ${result.message}`, 'success');
                    selectedFiles = [];
                    updateFileList();
                    checkDatabase();
                    clearFileSelection(); // Automatically clear selection after successful upload
                    // Show upload results with 'Show Full Data' button
                    if (result.uploaded_documents) {
                        const uploadResults = document.getElementById('uploadResults');
                        uploadResults.innerHTML = result.uploaded_documents.map(doc => `
                            <div class="file-item">
                                <span>📄 ${doc.filename} (${doc.document_type})</span>
                                <button class="btn" onclick="showFullData(${doc.id})">Show Full Data</button>
                            </div>
                            <div id="fullData-${doc.id}" style="display:none; background:#f8f9fa; border:1px solid #ddd; padding:10px; margin:5px 0; font-size:13px; white-space:pre-wrap;"></div>
                        `).join('');
                    }
                } else {
                    showStatus(`❌ Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Upload failed: ${error.message}`, 'error');
            }
        }

        async function clearDatabase() {
            if (!confirm('⚠️ Are you sure you want to clear ALL data from the database? This action cannot be undone!')) {
                return;
            }

            showStatus('Clearing database...', 'info');

            try {
                const response = await fetch('/clear-database', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus(`✅ ${result.message}`, 'success');
                    checkDatabase();
                } else {
                    showStatus(`❌ Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Failed to clear database: ${error.message}`, 'error');
            }
        }

        async function researchCompany() {
            const companyName = document.getElementById('companyName').value.trim();
            const searchProvider = document.getElementById('searchProvider').value;
            
            if (!companyName) {
                showStatus('❌ Please enter a company name', 'error');
                return;
            }

            showStatus('Researching company...', 'info');

            try {
                const response = await fetch('/company-research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        company_name: companyName,
                        provider: searchProvider || null
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    const companyInfo = document.getElementById('companyInfo');
                    const providerUsed = result.research_data?.provider_used || 'Unknown';
                    companyInfo.innerHTML = `
                        <div class="company-info">
                            <h4>🏢 ${result.company_name}</h4>
                            <p><strong>Search Provider:</strong> ${providerUsed}</p>
                            <p><strong>Industry:</strong> ${result.industry || 'N/A'}</p>
                            <p><strong>Size:</strong> ${result.size || 'N/A'}</p>
                            <p><strong>Location:</strong> ${result.location || 'N/A'}</p>
                            <p><strong>Website:</strong> ${result.website || 'N/A'}</p>
                            <p><strong>Description:</strong> ${result.description || 'N/A'}</p>
                        </div>
                    `;
                    showStatus(`✅ Company research completed using ${providerUsed}`, 'success');
                } else {
                    showStatus(`❌ Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Company research failed: ${error.message}`, 'error');
            }
        }

        async function loadSearchProviders() {
            try {
                const response = await fetch('/search-providers');
                const data = await response.json();
                
                const providerInfo = document.getElementById('searchProviderInfoContent');
                providerInfo.innerHTML = `
                    <div class="status info">
                        <h4>🔍 Available Search Providers:</h4>
                        <p><strong>Available:</strong> ${data.available_providers.join(', ') || 'None'}</p>
                        <p><strong>Rate Limits:</strong></p>
                        <ul>
                            <li>DuckDuckGo: ${data.rate_limits.duckduckgo}</li>
                            <li>Google: ${data.rate_limits.google}</li>
                            <li>Tavily: ${data.rate_limits.tavily}</li>
                            <li>YaCy: ${data.rate_limits.yacy}</li>
                            <li>SearXNG: ${data.rate_limits.searxng}</li>
                            <li>Brave Search: ${data.rate_limits.brave || '20 requests per minute'}</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                console.log('Could not load search providers info');
            }
        }

        async function loadLLMProviders() {
            try {
                const response = await fetch('/llm-providers');
                const data = await response.json();
                const providerDropdowns = ['llmProvider', 'batchLlmProvider', 'chatLlmProvider', 'uploadLlmProvider', 'visionLlmProvider'];
                const defaultProvider = data.current_provider || 'ollama';
                const autoOptionText = `Auto (Use Default: ${defaultProvider.charAt(0).toUpperCase() + defaultProvider.slice(1)})`;
                providerDropdowns.forEach(dropdownId => {
                    const llmProviderSelect = document.getElementById(dropdownId);
                    if (llmProviderSelect) {
                        llmProviderSelect.innerHTML = `<option value="">${autoOptionText}</option>`;
                        data.providers.forEach(provider => {
                            const isDefault = provider.name === data.current_provider;
                            const tick = isDefault ? '✅' : '';
                            const option = document.createElement('option');
                            option.value = provider.name;
                            option.textContent = `${provider.display_name} ${tick}`;
                            option.disabled = !provider.available;
                            llmProviderSelect.appendChild(option);
                        });
                        // Set current provider if available
                        const currentProvider = data.providers.find(p => p.name === data.current_provider);
                        if (currentProvider && currentProvider.available) {
                            llmProviderSelect.value = data.current_provider;
                        }
                    }
                });
            } catch (error) {
                console.log('Could not load LLM providers info');
            }
        }

        // Add a helper to show loading in a select
        function showLoadingOption(selectElement, text = 'Loading...') {
            selectElement.innerHTML = `<option value="">${text}</option>`;
        }

        // Patch all model loading functions to show 'Loading...' immediately
        async function loadLLMModels(provider, modelDropdownId = 'llmModel', modelGroupId = 'llmModelGroup') {
            const llmModelGroup = document.getElementById(modelGroupId);
            const llmModelSelect = document.getElementById(modelDropdownId);
            showLoadingOption(llmModelSelect);
            if (!provider) {
                try {
                    const response = await fetch('/llm-providers');
                    const data = await response.json();
                    const currentProvider = data.current_provider || 'ollama';
                    const modelResponse = await fetch(`/llm-models/${currentProvider}`);
                    const modelData = await modelResponse.json();
                    const defaultModel = modelData.current_model || 'llama3.2:latest';
                    llmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultModel})</option>`;
                    if (modelData.models && modelData.models.length > 0) {
                        modelData.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            if (model === modelData.current_model) {
                                option.textContent += ' (Default)';
                            }
                            llmModelSelect.appendChild(option);
                        });
                    }
                    llmModelGroup.style.display = 'block';
                } catch (error) {
                    llmModelSelect.innerHTML = '<option value="">Auto (Use Default)</option>';
                    llmModelGroup.style.display = 'block';
                }
                return;
            }
            try {
                const response = await fetch(`/llm-models/${provider}`);
                const data = await response.json();
                const defaultModel = data.current_model || '';
                llmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultModel})</option>`;
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === data.current_model) {
                            option.textContent += ' (Default)';
                        }
                        llmModelSelect.appendChild(option);
                    });
                    llmModelGroup.style.display = 'block';
                } else {
                    llmModelGroup.style.display = 'none';
                }
            } catch (error) {
                llmModelGroup.style.display = 'none';
            }
        }

        async function loadBatchLLMModels(provider) {
            const batchLlmModelGroup = document.getElementById('batchLlmModelGroup');
            const llmModelSelect = document.getElementById('batchLlmModel');
            showLoadingOption(llmModelSelect);
            if (!provider) {
                try {
                    const response = await fetch('/llm-providers');
                    const data = await response.json();
                    const currentProvider = data.current_provider || 'ollama';
                    const modelResponse = await fetch(`/llm-models/${currentProvider}`);
                    const modelData = await modelResponse.json();
                    const defaultModel = modelData.current_model || 'llama3.2:latest';
                    llmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultModel})</option>`;
                    if (modelData.models && modelData.models.length > 0) {
                        modelData.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            if (model === modelData.current_model) {
                                option.textContent += ' (Default)';
                            }
                            llmModelSelect.appendChild(option);
                        });
                    }
                    batchLlmModelGroup.style.display = 'block';
                } catch (error) {
                    llmModelSelect.innerHTML = '<option value="">Auto (Use Default)</option>';
                    batchLlmModelGroup.style.display = 'block';
                }
                return;
            }
            try {
                const response = await fetch(`/llm-models/${provider}`);
                const data = await response.json();
                const defaultModel = data.current_model || '';
                llmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultModel})</option>`;
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === data.current_model) {
                            option.textContent += ' (Default)';
                        }
                        llmModelSelect.appendChild(option);
                    });
                    batchLlmModelGroup.style.display = 'block';
                } else {
                    batchLlmModelGroup.style.display = 'none';
                }
            } catch (error) {
                batchLlmModelGroup.style.display = 'none';
            }
        }

        async function loadChatLLMModels(provider) {
            return new Promise(async (resolve) => {
                const chatLlmModelGroup = document.getElementById('chatLlmModelGroup');
                const llmModelSelect = document.getElementById('chatLlmModel');
                showLoadingOption(llmModelSelect);
                if (!provider) {
                    try {
                        const response = await fetch('/llm-providers');
                        const data = await response.json();
                        const currentProvider = data.current_provider || 'ollama';
                        const modelResponse = await fetch(`/llm-models/${currentProvider}`);
                        const modelData = await modelResponse.json();
                        const defaultModel = modelData.current_model || 'llama3.2:latest';
                        llmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultModel})</option>`;
                        if (modelData.models && modelData.models.length > 0) {
                            modelData.models.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model;
                                option.textContent = model;
                                if (model === modelData.current_model) {
                                    option.textContent += ' (Default)';
                                }
                                llmModelSelect.appendChild(option);
                            });
                        }
                        chatLlmModelGroup.style.display = 'block';
                    } catch (error) {
                        llmModelSelect.innerHTML = '<option value="">Auto (Use Default)</option>';
                        chatLlmModelGroup.style.display = 'block';
                    }
                    resolve();
                    return;
                }
                try {
                    const response = await fetch(`/llm-models/${provider}`);
                    const data = await response.json();
                    const defaultModel = data.current_model || '';
                    llmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultModel})</option>`;
                    if (data.models && data.models.length > 0) {
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            if (model === data.current_model) {
                                option.textContent += ' (Default)';
                            }
                            llmModelSelect.appendChild(option);
                        });
                    }
                    chatLlmModelGroup.style.display = 'block';
                    resolve();
                } catch (error) {
                    chatLlmModelGroup.style.display = 'none';
                    resolve();
                }
            });
        }

        async function loadUploadLLMModels(provider) {
            const uploadLlmModelGroup = document.getElementById('uploadLLMModelGroup');
            const llmModelSelect = document.getElementById('uploadLlmModel');
            showLoadingOption(llmModelSelect);
            const useLLMExtractionChecked = document.getElementById('useLLMExtraction').checked;
            if (!provider) {
                try {
                    const response = await fetch('/llm-providers');
                    const data = await response.json();
                    const currentProvider = data.current_provider || 'ollama';
                    const modelResponse = await fetch(`/llm-models/${currentProvider}`);
                    const modelData = await modelResponse.json();
                    const defaultModel = modelData.current_model || 'llama3.2:latest';
                    llmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultModel})</option>`;
                    if (modelData.models && modelData.models.length > 0) {
                        modelData.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            if (model === modelData.current_model) {
                                option.textContent += ' (Default)';
                            }
                            llmModelSelect.appendChild(option);
                        });
                    }
                    // Only show if useLLMExtraction is checked
                    uploadLlmModelGroup.style.display = useLLMExtractionChecked ? 'block' : 'none';
                } catch (error) {
                    llmModelSelect.innerHTML = '<option value="">Auto (Use Default)</option>';
                    uploadLlmModelGroup.style.display = useLLMExtractionChecked ? 'block' : 'none';
                }
                return;
            }
            try {
                const response = await fetch(`/llm-models/${provider}`);
                const data = await response.json();
                const defaultModel = data.current_model || '';
                llmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultModel})</option>`;
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === data.current_model) {
                            option.textContent += ' (Default)';
                        }
                        llmModelSelect.appendChild(option);
                    });
                    uploadLlmModelGroup.style.display = useLLMExtractionChecked ? 'block' : 'none';
                } else {
                    uploadLlmModelGroup.style.display = 'none';
                }
            } catch (error) {
                uploadLlmModelGroup.style.display = 'none';
            }
        }

        async function loadVisionLLMModels(provider) {
            const visionLlmModelGroup = document.getElementById('visionLlmModelGroup');
            const visionLlmModelSelect = document.getElementById('visionLlmModel');
            showLoadingOption(visionLlmModelSelect);
            if (!provider) {
                try {
                    const response = await fetch('/llm-providers');
                    const data = await response.json();
                    const currentProvider = data.current_provider || 'ollama';
                    const modelResponse = await fetch(`/llm-models/${currentProvider}`);
                    const modelData = await modelResponse.json();
                    const visionResponse = await fetch(`/vision-models-available/${currentProvider}`);
                    const visionData = await visionResponse.json();
                    const defaultVisionModel = modelData.default_vision_model || modelData.current_model || 'llava:latest';
                    if (!visionData.has_vision_models) {
                        visionLlmModelSelect.innerHTML = `<option value="">Auto (No vision model available - Default: ${defaultVisionModel})</option>`;
                    } else {
                        visionLlmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultVisionModel})</option>`;
                    }
                    if (modelData.models && modelData.models.length > 0) {
                        modelData.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            if (model === defaultVisionModel) {
                                option.textContent += ' (Default)';
                            }
                            visionLlmModelSelect.appendChild(option);
                        });
                    }
                    visionLlmModelGroup.style.display = 'block';
                } catch (error) {
                    visionLlmModelSelect.innerHTML = '<option value="">Auto (No vision model available - Default: llava:latest)</option>';
                    visionLlmModelGroup.style.display = 'block';
                }
                return;
            }
            try {
                const response = await fetch(`/llm-models/${provider}`);
                const data = await response.json();
                const visionResponse = await fetch(`/vision-models-available/${provider}`);
                const visionData = await visionResponse.json();
                const defaultVisionModel = data.default_vision_model || data.current_model || 'llava:latest';
                if (!visionData.has_vision_models) {
                    visionLlmModelSelect.innerHTML = `<option value="">Auto (No vision model available - Default: ${defaultVisionModel})</option>`;
                } else {
                    visionLlmModelSelect.innerHTML = `<option value="">Auto (Use Default: ${defaultVisionModel})</option>`;
                }
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === defaultVisionModel) {
                            option.textContent += ' (Default)';
                        }
                        visionLlmModelSelect.appendChild(option);
                    });
                }
                visionLlmModelGroup.style.display = 'block';
            } catch (error) {
                visionLlmModelSelect.innerHTML = '<option value="">Auto (No vision model available - Default: llava:latest)</option>';
                visionLlmModelGroup.style.display = 'block';
            }
        }

        async function generateCoverLetter() {
            const jobTitle = document.getElementById('jobTitle').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            const jobDescription = document.getElementById('jobDescription').value.trim();
            const tone = document.getElementById('tone').value;
            const includeCompanyResearch = document.getElementById('includeCompanyResearch').checked;
            const researchProvider = document.getElementById('singleSearchProvider') ? document.getElementById('singleSearchProvider').value : '';
            const researchCountry = document.getElementById('researchCountry') ? document.getElementById('researchCountry').value : '';
            const llmProvider = document.getElementById('llmProvider').value;
            const llmModel = document.getElementById('llmModel').value;
            const strictRelevance = document.getElementById('strictRelevance').checked;

            const payload = {
                job_title: jobTitle,
                company_name: companyName,
                job_description: jobDescription,
                tone: tone,
                include_company_research: includeCompanyResearch,
                research_provider: researchProvider,
                research_country: researchCountry,
                llm_provider: llmProvider,
                llm_model: llmModel,
                strict_relevance: strictRelevance
            };

            if (!jobTitle || !companyName || !jobDescription) {
                showStatus('❌ Please fill in all required fields', 'error');
                return;
            }

            showStatus('Generating cover letter...', 'info');

            try {
                const response = await fetch('/generate-cover-letter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && !result.error && !result.warning && !result.detail?.toString().toLowerCase().includes('deprecated_endpoint')) {
                    const preview = document.getElementById('coverLetterPreview');
                    preview.innerHTML = `
                        <h3>📝 Generated Cover Letter</h3>
                        <div class="cover-letter-preview">${result.generated_content}</div>
                        <div style="margin-top: 20px;">
                            <button class="btn" onclick="exportCoverLetter(${result.id}, 'pdf')">📄 Export as PDF</button>
                            <button class="btn" onclick="exportCoverLetter(${result.id}, 'docx')">📝 Export as DOCX</button>
                            <button class="btn" onclick="exportCoverLetter(${result.id}, 'txt')">📄 Export as TXT</button>
                        </div>
                    `;
                    showStatus('✅ Cover letter generated successfully', 'success');
                    checkDatabase();
                } else {
                    let errorMsg = result.detail || result.error || result.warning || 'Unknown error.';
                    if (errorMsg.toString().toLowerCase().includes('deprecated_endpoint')) {
                        errorMsg = '❌ Model API error: DEPRECATED_ENDPOINT. Please check your model provider or try a different model.';
                    }
                    showStatus(`❌ Error: ${errorMsg}`, 'error');
                    // Prevent further processing
                    return;
                }
            } catch (error) {
                showStatus(`❌ Cover letter generation failed: ${error.message}`, 'error');
            }
        }

        async function exportCoverLetter(coverLetterId, format) {
            showStatus(`Exporting as ${format.toUpperCase()}...`, 'info');

            try {
                const response = await fetch(`/export-cover-letter/${coverLetterId}?format=${format}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus(`✅ Cover letter exported as ${format.toUpperCase()}`, 'success');
                    // You could add download functionality here
                } else {
                    showStatus(`❌ Export failed: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Export failed: ${error.message}`, 'error');
            }
        }

        async function checkDatabase() {
            try {
                const response = await fetch('/database-contents');
                const data = await response.json();
                databaseData = data;

                const databaseStatus = document.getElementById('databaseStatus');
                
                // Safely filter documents with null checks
                const documents = data.documents || [];
                const cvDocs = documents.filter(doc => doc && doc.document_type && typeof doc.document_type === 'string' && doc.document_type.toLowerCase().includes('cv'));
                const coverLetterDocs = documents.filter(doc => doc && doc.document_type && typeof doc.document_type === 'string' && doc.document_type.toLowerCase().includes('cover'));
                const otherDocs = documents.filter(doc => doc && (!doc.document_type || (typeof doc.document_type === 'string' && !doc.document_type.toLowerCase().includes('cv') && !doc.document_type.toLowerCase().includes('cover'))));

                const coverLetters = data.cover_letters || [];
                const experiences = data.experiences || [];
                const companyResearch = data.company_research || [];

                databaseStatus.innerHTML = `
                    <div class="status info">
                        <h4>📊 Database Summary:</h4>
                        <p><span class="summary-label">📄 CV/Resume</span> <span class="summary-count">(${cvDocs.length})</span></p>
                        <p><span class="summary-label">📝 Generated Cover Letters</span> <span class="summary-count">(${coverLetters.length})</span></p>
                        <p><span class="summary-label">📄 Uploaded Cover Letters</span> <span class="summary-count">(${coverLetterDocs.length})</span></p>
                        <p><span class="summary-label">💼 Experiences</span> <span class="summary-count">(${experiences.length})</span></p>
                        <p><span class="summary-label">🏢 Company Research</span> <span class="summary-count">(${companyResearch.length})</span></p>
                    </div>
                `;

                // Show detailed database contents with collapsible sections
                const databaseDetails = document.getElementById('databaseDetails');
                let detailsHtml = '';

                // CV/Resume Section
                detailsHtml += createCollapsibleSection('cv', '📄 CV/Resume', cvDocs, 'cv', 'document');
                
                // Cover Letters Section - handle generated and uploaded separately
                detailsHtml += createCollapsibleSection('cover_letters', '📝 Generated Cover Letters', coverLetters, 'cover_letters', 'cover_letter');
                detailsHtml += createCollapsibleSection('cover_letter_docs', '📄 Uploaded Cover Letters', coverLetterDocs, 'cover_letter_docs', 'document');
                
                // Other Documents Section
                detailsHtml += createCollapsibleSection('other_documents', '📄 Other Documents', otherDocs, 'other_documents', 'document');
                
                // Experiences Section
                detailsHtml += createCollapsibleSection('experiences', '💼 Experiences', experiences, 'experiences', 'experience');
                
                // Company Research Section
                detailsHtml += createCollapsibleSection('company_research', '🏢 Company Research', companyResearch, 'company_research', 'company_research');

                databaseDetails.innerHTML = detailsHtml;
                updateSelectedCount();

            } catch (error) {
                console.error('Database check error:', error);
                showStatus(`❌ Failed to check database: ${error.message}`, 'error');
                
                // Show a fallback message
                const databaseDetails = document.getElementById('databaseDetails');
                if (databaseDetails) {
                    databaseDetails.innerHTML = `
                        <div class="empty-section">
                            <div class="empty-icon">⚠️</div>
                            <p>Error loading database contents</p>
                            <p>Please check the console for more details and try refreshing the page.</p>
                        </div>
                    `;
                }
            }
        }

        function createCollapsibleSection(sectionId, title, items, dataType, itemType) {
            if (!items || items.length === 0) {
                return `
                    <div class="collapsible-section">
                        <div class="collapsible-header" onclick="toggleSection('${sectionId}')">
                            <span><span class="section-icon">${title.split(' ')[0]}</span>${title.split(' ').slice(1).join(' ')}</span>
                            <span class="section-count">0</span>
                            <span class="toggle-icon">▼</span>
                        </div>
                        <div class="collapsible-content collapsed" id="content-${sectionId}">
                            <div class="section-items">
                                <div class="empty-section">
                                    <div class="empty-icon">📭</div>
                                    <p>No ${title.toLowerCase()} found</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            let itemsHtml = '';
            if (items.length > 10) {
                itemsHtml += `<div class="scroll-indicator">⬇️ Scroll to see all ${items.length} items</div>`;
            }
            items.forEach(item => {
                if (!item) return; // Skip null/undefined items
                

                
                let itemContent, itemId, itemTitle, itemWeight;
                
                try {
                    if (itemType === 'cover_letter') {
                        // Cover letter - could be from cover_letters table or documents table
                        if (item.job_title) {
                            // Generated cover letter from cover_letters table
                            itemContent = `<strong>${item.job_title || 'Cover Letter'}</strong> at ${item.company_name || ''} - ${item.generated_at || ''}`;
                            itemId = item.id;
                            itemTitle = item.job_title || 'Cover Letter';
                        } else if (item.filename) {
                            // Cover letter document from documents table
                            itemContent = `<strong>${item.filename || 'Cover Letter'}</strong> (Cover Letter) - ${item.uploaded_at || 'Unknown Date'}`;
                            itemId = item.id;
                            itemTitle = item.filename || 'Cover Letter';
                        } else {
                            // Fallback for cover letter
                            itemContent = `<strong>Cover Letter</strong> - ID: ${item.id || 'Unknown'}`;
                            itemId = item.id;
                            itemTitle = 'Cover Letter';
                        }
                    } else if (itemType === 'document') {
                        // Document
                        const manualWeight = item.manual_weight || 1.0;
                        itemContent = `<strong>${item.filename || 'Unknown File'}</strong> (${item.document_type || 'Document'}) - ${item.uploaded_at || 'Unknown Date'}`;
                        itemId = item.id;
                        itemTitle = item.filename || 'Unknown File';
                        
                        // Store weight info for use in actions
                        itemWeight = manualWeight;
                    } else if (itemType === 'experience') {
                        // Experience
                        itemContent = `<strong>${item.title || 'Unknown Title'}</strong> at ${item.company || 'Unknown Company'} - ${item.start_date || 'Unknown Date'}`;
                        itemId = item.id;
                        itemTitle = item.title || 'Unknown Title';
                    } else if (itemType === 'company_research') {
                        // Company Research
                        itemContent = `<strong>${item.company_name || 'Unknown Company'}</strong> - ${item.researched_at || 'Unknown Date'}`;
                        itemId = item.id;
                        itemTitle = item.company_name || 'Unknown Company';
                    } else {
                        // Fallback for unknown item types
                        itemContent = `<strong>Unknown Item</strong> - ID: ${item.id || 'Unknown'}`;
                        itemId = item.id;
                        itemTitle = 'Unknown Item';
                    }

                    // Ensure itemTitle and itemContent are strings before calling toLowerCase()
                    const safeTitle = (itemTitle || '').toString().toLowerCase();
                    const safeContent = (itemContent || '').toString().toLowerCase();

                    itemsHtml += `
                        <div class="database-item" data-type="${dataType}" data-title="${safeTitle}" data-content="${safeContent}">
                            <input type="checkbox" class="${dataType}-checkbox" value="${itemId}" data-type="${dataType}">
                            <div class="database-item-content">
                                ${itemContent}
                            </div>
                            <div class="database-item-actions">
                                ${itemType === 'document' ? `
                                    <div style="display: flex; align-items: center; gap: 8px; margin-right: 10px;">
                                        <label style="font-size: 11px; color: #666;">Weight:</label>
                                        <input type="number" 
                                               id="weight-${itemId}" 
                                               value="${itemWeight || 1.0}" 
                                               min="0.1" 
                                               max="10.0" 
                                               step="0.1" 
                                               style="width: 60px; padding: 1px 3px; font-size: 11px; border: 1px solid #ccc; border-radius: 3px;"
                                               onchange="updateDocumentWeight(${itemId}, this.value)"
                                               title="Manual weight multiplier (0.1x - 10.0x)">
                                        <button class="btn" style="padding: 1px 4px; font-size: 10px; background: #17a2b8; color: white; border: none; border-radius: 3px;" 
                                                onclick="getDocumentWeightInfo(${itemId})" 
                                                title="Weight information">ℹ️</button>
                                    </div>
                                ` : ''}
                                <button class="view-item-btn" onclick="viewItem('${itemType}', ${itemId})">👁️ View</button>
                                <button class="delete-item-btn" onclick="deleteItem('${itemType}', ${itemId})">🗑️ Delete</button>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error processing item:', item, error);
                    // Add a fallback item for debugging
                    itemsHtml += `
                        <div class="database-item" data-type="${dataType}" data-title="error" data-content="error">
                            <input type="checkbox" class="${dataType}-checkbox" value="error" data-type="${dataType}">
                            <div class="database-item-content">
                                <strong>Error Processing Item</strong> - Check console for details
                            </div>
                            <div class="database-item-actions">
                                <button class="view-item-btn" disabled>👁️ View</button>
                                <button class="delete-item-btn" disabled>🗑️ Delete</button>
                            </div>
                        </div>
                    `;
                }
            });

            return `
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('${sectionId}')">
                        <span><span class="section-icon">${title.split(' ')[0]}</span>${title.split(' ').slice(1).join(' ')}</span>
                        <span class="section-count">${items.length}</span>
                        <span class="toggle-icon">▼</span>
                    </div>
                    <div class="collapsible-content" id="content-${sectionId}">
                        <div class="section-items">
                            ${itemsHtml}
                        </div>
                    </div>
                </div>
            `;
        }

        function showStatus(message, type = 'info', targetId = 'status') {
            const statusDiv = document.getElementById(targetId || 'status');
            if (!statusDiv) return;
            let color, icon;
            if (type === 'success') { color = '#d4edda'; icon = '✅'; }
            else if (type === 'error') { color = '#f8d7da'; icon = '❌'; }
            else { color = '#d1ecf1'; icon = 'ℹ️'; }
            statusDiv.innerHTML = `<div class="status ${type}" style="background:${color};padding:10px;border-radius:5px;margin:10px 0;">${icon} ${message}</div>`;
        }

        // Check database on page load
        checkDatabase();
        
        // Load search providers info when generate tab is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Load search providers info
            loadSearchProviders();
            
            // Load LLM providers info
            loadLLMProviders();
            
            // Add event listener for batch company research checkbox
            document.getElementById('batchIncludeCompanyResearch').addEventListener('change', function() {
                const providerGroup = document.getElementById('batchResearchProviderGroup');
                const countryGroup = document.getElementById('batchResearchCountryGroup');
                if (this.checked) {
                    providerGroup.style.display = 'block';
                    countryGroup.style.display = 'block';
                } else {
                    providerGroup.style.display = 'none';
                    countryGroup.style.display = 'none';
                }
            });
            
            // Add event listener for single company research checkbox
            document.getElementById('includeCompanyResearch').addEventListener('change', function() {
                const providerGroup = document.getElementById('singleResearchProviderGroup');
                const countryGroup = document.getElementById('singleResearchCountryGroup');
                if (this.checked) {
                    providerGroup.style.display = 'block';
                    countryGroup.style.display = 'block';
                } else {
                    providerGroup.style.display = 'none';
                    countryGroup.style.display = 'none';
                }
            });
            
            // Show provider selection if company research is already checked
            if (document.getElementById('includeCompanyResearch').checked) {
                document.getElementById('singleResearchProviderGroup').style.display = 'block';
                document.getElementById('singleResearchCountryGroup').style.display = 'block';
            }
            if (document.getElementById('batchIncludeCompanyResearch').checked) {
                document.getElementById('batchResearchProviderGroup').style.display = 'block';
                document.getElementById('batchResearchCountryGroup').style.display = 'block';
            }
            
            // Add event listener for LLM provider selection
            document.getElementById('llmProvider').addEventListener('change', function() {
                console.log('LLM provider changed to:', this.value);
                console.log('Provider element value:', this.value);
                loadLLMModels(this.value);
            });
            
            // Add event listener for batch LLM provider selection
            document.getElementById('batchLlmProvider').addEventListener('change', function() {
                console.log('Batch LLM provider changed to:', this.value);
                loadBatchLLMModels(this.value);
            });
            
            // Add event listener for chat LLM provider selection
            document.getElementById('chatLlmProvider').addEventListener('change', function() {
                const provider = this.value;
                // Save the current model selection for the previous provider
                const prevProvider = this.getAttribute('data-prev-provider');
                if (prevProvider) {
                    const prevModel = document.getElementById('chatLlmModel').value;
                    chatProviderModelSelections[prevProvider] = prevModel;
                }
                // Load models for the new provider
                loadChatLLMModels(provider).then(() => {
                    // Restore last selected model for this provider, if any
                    const lastModel = chatProviderModelSelections[provider] || '';
                    const modelSelect = document.getElementById('chatLlmModel');
                    if (modelSelect && lastModel) {
                        modelSelect.value = lastModel;
                    }
                });
                this.setAttribute('data-prev-provider', provider);
            });

            // Add event listener for upload LLM provider selection
            document.getElementById('uploadLlmProvider').addEventListener('change', function() {
                console.log('Upload LLM provider changed to:', this.value);
                loadUploadLLMModels(this.value);
            });

            // Add event listener for LLM extraction checkbox
            document.getElementById('useLLMExtraction').addEventListener('change', function() {
                const useLLM = this.checked;
                const providerGroup = document.getElementById('uploadLLMProviderGroup');
                const modelGroup = document.getElementById('uploadLLMModelGroup');
                if (useLLM) {
                    providerGroup.style.display = 'block';
                    modelGroup.style.display = 'block';
                    // Load models for the current provider selection
                    const currentProvider = document.getElementById('uploadLlmProvider').value;
                    loadUploadLLMModels(currentProvider);
                } else {
                    providerGroup.style.display = 'none';
                    modelGroup.style.display = 'none';
                }
            });
            
            // Load models for the current provider selections after providers are loaded
            // This ensures models are loaded for the correct providers
            setTimeout(() => {
                const llmProvider = document.getElementById('llmProvider').value;
                const batchLlmProvider = document.getElementById('batchLlmProvider').value;
                const chatLlmProvider = document.getElementById('chatLlmProvider').value;
                
                loadLLMModels(llmProvider || 'ollama');
                loadBatchLLMModels(batchLlmProvider || 'ollama');
                loadChatLLMModels(chatLlmProvider || 'ollama');
            }, 100); // Small delay to ensure providers are loaded first
        });

        // Chat functionality
        let currentCoverLetter = null;
        let chatHistory = [];

        async function loadCoverLetters() {
            try {
                const response = await fetch('/database-contents');
                const data = await response.json();
                
                const coverLetterList = document.getElementById('coverLetterList');
                if (data.cover_letters.length === 0) {
                    coverLetterList.innerHTML = '<p>No cover letters found. Generate one first!</p>';
                    // Clear chat messages and show instruction
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '<div class="message assistant">👋 Hi! I\'m here to help you edit your cover letter. First, generate a cover letter in the "Generate Cover Letter" tab, then come back here to chat and edit it.</div>';
                    return;
                }

                let html = '';
                data.cover_letters.forEach((cl, index) => {
                    html += `
                        <div class="cover-letter-item" onclick="selectCoverLetter(${cl.id}, '${cl.job_title} at ${cl.company_name}')">
                            <strong>${cl.job_title}</strong><br>
                            <small>${cl.company_name}</small><br>
                            <small>${cl.generated_at}</small>
                        </div>
                    `;
                });
                coverLetterList.innerHTML = html;
            } catch (error) {
                console.error('Failed to load cover letters:', error);
            }
        }

        // --- Revised Version Tab Logic ---
        let revisedTab = 'diff'; // 'diff' or 'edit'
        let diffViewMode = 'diff'; // 'diff' (strikethrough) or 'final' (complete revised)
        function switchRevisedTab(tab) {
            revisedTab = tab;
            document.getElementById('showChangesTab').classList.toggle('revised-tab-active', tab === 'diff');
            document.getElementById('editRevisedTab').classList.toggle('revised-tab-active', tab === 'edit');
            document.getElementById('revisedDiffPanel').style.display = tab === 'diff' ? 'block' : 'none';
            document.getElementById('revisedEditPanel').style.display = tab === 'edit' ? 'block' : 'none';
            if (tab === 'diff') {
                updateDiffDisplay(diffViewMode);
            } else {
                // Populate editable content with latest revised version, preserving formatting
                const revisedContent = document.getElementById('revisedDiffContent').textContent;
                const editContent = document.getElementById('revisedEditContent');
                // Use textContent to preserve line breaks and spacing
                editContent.textContent = revisedContent;
                // Check if there are changes and show save options if needed
                setTimeout(() => {
                    checkAndShowSaveOptions();
                }, 100); // Small delay to ensure content is loaded
            }
        }
        // --- End Revised Version Tab Logic ---

        // Function to toggle between diff view and final view
        function toggleDiffView() {
            if (diffViewMode === 'diff') {
                diffViewMode = 'final';
                document.getElementById('showChangesTab').textContent = 'Show Diff';
            } else {
                diffViewMode = 'diff';
                document.getElementById('showChangesTab').textContent = 'Show Changes';
            }
            updateDiffDisplay(diffViewMode);
        }

        // Patch selectCoverLetter to update both panels
        async function selectCoverLetter(id, title) {
            currentCoverLetter = id;
            document.querySelectorAll('.cover-letter-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.cover-letter-item').classList.add('active');
            document.getElementById('exportButtons').style.display = 'flex';
            document.getElementById('saveOptions').style.display = 'none';
            window.updatedCoverLetterContent = null;
            // Reset diff view mode to 'diff' when selecting a new cover letter
            diffViewMode = 'diff';
            document.getElementById('showChangesTab').textContent = 'Show Changes';
            try {
                const response = await fetch(`/cover-letter/${id}`);
                const data = await response.json();
                if (response.ok) {
                    // Set current version (this never changes)
                    document.getElementById('currentCoverLetterContent').textContent = data.generated_content;
                    // Set revised version to match current initially
                    document.getElementById('revisedDiffContent').textContent = data.generated_content;
                    document.getElementById('revisedEditContent').textContent = data.generated_content;
                    document.getElementById('coverLettersPanel').style.display = 'flex';
                    originalContent = data.generated_content;
                    currentContent = data.generated_content;
                    updateDiffDisplay(diffViewMode);
                    // Reset to diff tab when selecting a new cover letter
                    switchRevisedTab('diff');
                }
            } catch (error) {
                console.error('Failed to load cover letter content:', error);
            }
            addMessage(`I'm ready to help you edit the cover letter for "${title}". What would you like to change?`, 'assistant');
        }

        // Function to convert contenteditable HTML to plain text with proper line breaks
        function getEditableTextContent(element) {
            // Get the HTML content from the contenteditable div
            const html = element.innerHTML;
            
            // Convert <div> and <br> tags to line breaks
            let text = html
                .replace(/<div>/g, '\n')
                .replace(/<br>/g, '\n')
                .replace(/<\/div>/g, '')
                .replace(/<div><br><\/div>/g, '\n') // Empty divs become line breaks
                .replace(/<div><\/div>/g, '\n'); // Empty divs become line breaks
            
            // Remove any remaining HTML tags
            text = text.replace(/<[^>]+>/g, '');
            
            // Normalize line endings
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // Remove leading/trailing whitespace but preserve internal spacing
            text = text.trim();
            
            return text;
        }

        // Function to check and show save options if there are changes
        function checkAndShowSaveOptions() {
            const currentText = document.getElementById('currentCoverLetterContent').textContent;
            const revisedElement = document.getElementById('revisedEditContent');
            const revisedText = getEditableTextContent(revisedElement);
            
            // Normalize line endings for comparison but preserve all whitespace
            const normalizedCurrent = currentText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const normalizedRevised = revisedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            if (normalizedCurrent !== normalizedRevised) {
                document.getElementById('saveOptions').style.display = 'block';
                document.getElementById('saveStatus').textContent = 'You have unsaved changes. Choose how to save them:';
            } else {
                document.getElementById('saveOptions').style.display = 'none';
            }
        }

        // Add event listener for manual edits in the editable content
        document.addEventListener('DOMContentLoaded', function() {
            const revisedEditContent = document.getElementById('revisedEditContent');
            if (revisedEditContent) {
                revisedEditContent.addEventListener('input', function() {
                    // Check if there are changes when user edits manually
                    const currentText = document.getElementById('currentCoverLetterContent').textContent;
                    const revisedText = getEditableTextContent(this);
                    
                    // Normalize line endings for comparison but preserve all whitespace
                    const normalizedCurrent = currentText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                    const normalizedRevised = revisedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                    
                    if (normalizedCurrent !== normalizedRevised) {
                        document.getElementById('saveOptions').style.display = 'block';
                        document.getElementById('saveStatus').textContent = 'You have unsaved changes. Choose how to save them:';
                    } else {
                        document.getElementById('saveOptions').style.display = 'none';
                    }
                });
            }

            // Add Enter key functionality for chat input
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); // Prevent default Enter behavior
                        sendChatMessage();
                    }
                });
            }
        });

        // Unified function to update diff display
        function updateDiffDisplay(viewMode) {
            const currentText = document.getElementById('currentCoverLetterContent').textContent;
            const revisedText = document.getElementById('revisedDiffContent').textContent;
            
            // Normalize line endings for comparison but preserve all whitespace
            const normalizedCurrent = currentText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const normalizedRevised = revisedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            if (normalizedCurrent === normalizedRevised) {
                // No changes - show the content normally with proper formatting
                document.getElementById('noChangesMessage').style.display = 'flex';
                document.getElementById('revisedDiffContent').style.display = 'none';
                document.getElementById('diffStatus').textContent = 'No changes detected';
            } else {
                // Changes detected - show the diff with proper highlighting
                document.getElementById('noChangesMessage').style.display = 'none';
                document.getElementById('revisedDiffContent').style.display = 'block';
                
                if (viewMode === 'final') {
                    // Show the complete revised version without diff highlighting
                    document.getElementById('revisedDiffContent').textContent = revisedText;
                    document.getElementById('diffStatus').textContent = 'Showing final revised version';
                } else {
                    // Show the diff with strikethrough and additions
                    const diffHtml = generateDiff(normalizedCurrent, normalizedRevised);
                    document.getElementById('revisedDiffContent').innerHTML = diffHtml;
                    
                    // Count changes for status
                    const changeCount = countChanges(diffHtml);
                    document.getElementById('diffStatus').textContent = `${changeCount} changes detected`;
                }
            }
        }

        function generateDiff(original, revised) {
            // Split into lines for better diff visualization
            const originalLines = original.split('\n');
            const revisedLines = revised.split('\n');
            
            let diffHtml = '';
            let i = 0, j = 0;
            
            while (i < originalLines.length || j < revisedLines.length) {
                if (i < originalLines.length && j < revisedLines.length && originalLines[i] === revisedLines[j]) {
                    // Lines match - show as unchanged
                    diffHtml += `<div class="diff-unchanged">${escapeHtml(originalLines[i])}</div>`;
                    i++;
                    j++;
                } else {
                    // Lines don't match - find the best match
                    let found = false;
                    
                    // Look ahead in revised text for a match
                    for (let k = j + 1; k < Math.min(j + 3, revisedLines.length); k++) {
                        if (i < originalLines.length && originalLines[i] === revisedLines[k]) {
                            // Add removed lines from original
                            for (let m = j; m < k; m++) {
                                diffHtml += `<div class="diff-added">+ ${escapeHtml(revisedLines[m])}</div>`;
                            }
                            j = k;
                            found = true;
                            break;
                        }
                    }
                    
                    // Look ahead in original text for a match
                    if (!found) {
                        for (let k = i + 1; k < Math.min(i + 3, originalLines.length); k++) {
                            if (j < revisedLines.length && originalLines[k] === revisedLines[j]) {
                                // Add removed lines from original
                                for (let m = i; m < k; m++) {
                                    diffHtml += `<div class="diff-removed">- ${escapeHtml(originalLines[m])}</div>`;
                                }
                                i = k;
                                found = true;
                                break;
                            }
                        }
                    }
                    
                    // If no match found, mark as changed
                    if (!found) {
                        if (i < originalLines.length) {
                            diffHtml += `<div class="diff-removed">- ${escapeHtml(originalLines[i])}</div>`;
                            i++;
                        }
                        if (j < revisedLines.length) {
                            diffHtml += `<div class="diff-added">+ ${escapeHtml(revisedLines[j])}</div>`;
                            j++;
                        }
                    }
                }
            }
            
            return diffHtml;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function countChanges(diffHtml) {
            const addedMatches = diffHtml.match(/class="diff-added"/g);
            const removedMatches = diffHtml.match(/class="diff-removed"/g);
            const addedCount = addedMatches ? addedMatches.length : 0;
            const removedCount = removedMatches ? removedMatches.length : 0;
            return addedCount + removedCount;
        }

        // Patch chat response to update only revised version
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            if (!currentCoverLetter) {
                addMessage('Please select a cover letter first!', 'assistant');
                return;
            }

            // Add user message
            addMessage(message, 'user');
            input.value = '';
            
            // Disable send button
            const sendBtn = document.getElementById('sendChatBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            try {
                const chatLlmProvider = document.getElementById('chatLlmProvider').value;
                const chatLlmModel = document.getElementById('chatLlmModel').value;
                
                const response = await fetch('/chat-with-cover-letter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cover_letter_id: currentCoverLetter,
                        message: message,
                        llm_provider: chatLlmProvider || null,
                        llm_model: chatLlmModel || null
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    /* addMessage(result.response, 'assistant'); */
                    if (result.updated_content) {
                        // Store the previous revised content BEFORE updating the DOM
                        const prevRevisedText = document.getElementById('revisedDiffContent').textContent;
                        // Normalize line endings for comparison
                        const normalizedPrevRevised = prevRevisedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                        const normalizedUpdated = result.updated_content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                        if (normalizedPrevRevised !== normalizedUpdated) {
                            addMessage(`✅ Cover letter updated! Here's the new version:\n\n${result.updated_content}`, 'assistant');
                        } else {
                            addMessage('No changes were made to your cover letter.', 'assistant');
                        }
                        // Update only the revised version panels, NEVER the current version
                        document.getElementById('revisedDiffContent').textContent = result.updated_content;
                        document.getElementById('revisedEditContent').textContent = result.updated_content;
                        document.getElementById('saveOptions').style.display = 'block';
                        document.getElementById('saveStatus').textContent = 'Your cover letter has been updated. Choose how to save it:';
                        window.updatedCoverLetterContent = result.updated_content;
                        updateDiffDisplay(diffViewMode);
                    }
                } else {
                    addMessage(`❌ Error: ${result.detail}`, 'assistant');
                }
            } catch (error) {
                addMessage(`❌ Failed to send message: ${error.message}`, 'assistant');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        // Function to update the current version (only called when user explicitly chooses to)
        async function updateCurrentVersion() {
            const revisedDiv = document.getElementById('revisedEditContent');
            const content = getEditableTextContent(revisedDiv);
            const saveStatus = document.getElementById('saveStatus');
            if (!currentCoverLetter) {
                saveStatus.textContent = 'No cover letter selected!';
                return;
            }
            saveStatus.textContent = 'Updating current version...';
            try {
                const response = await fetch(`/update-cover-letter/${currentCoverLetter}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ generated_content: content })
                });
                if (response.ok) {
                    saveStatus.textContent = '✅ Current version updated successfully!';
                    // NOW update the current version to show the saved content
                    document.getElementById('currentCoverLetterContent').textContent = content;
                    // Also update the revised panels to match the new current version
                    document.getElementById('revisedDiffContent').textContent = content;
                    document.getElementById('revisedEditContent').textContent = content;
                    updateDiffDisplay(diffViewMode);
                    // Update stored content
                    originalContent = content;
                    currentContent = content;
                    // Hide save options and switch to diff view
                    setTimeout(() => { 
                        document.getElementById('saveOptions').style.display = 'none';
                        switchRevisedTab('diff');
                    }, 1000);
                    loadCoverLetters();
                } else {
                    const result = await response.json();
                    saveStatus.textContent = `❌ Failed to update: ${result.detail}`;
                }
            } catch (error) {
                saveStatus.textContent = `❌ Failed to update: ${error.message}`;
            }
        }

        // Function to cancel edits and revert to original
        function cancelEdit() {
            // Revert the revised content to match the current version
            const currentText = document.getElementById('currentCoverLetterContent').textContent;
            document.getElementById('revisedDiffContent').textContent = currentText;
            document.getElementById('revisedEditContent').textContent = currentText;
            // Hide save options
            document.getElementById('saveOptions').style.display = 'none';
            // Switch back to diff view
            switchRevisedTab('diff');
        }

        // Patch saveAsNew to use the proper text extraction
        async function saveAsNew() {
            const revisedDiv = document.getElementById('revisedEditContent');
            const content = getEditableTextContent(revisedDiv); // Use proper text extraction
            const saveStatus = document.getElementById('saveStatus');
            if (!currentCoverLetter) {
                saveStatus.textContent = 'No cover letter selected!';
                return;
            }
            saveStatus.textContent = 'Saving...';
            try {
                const response = await fetch(`/cover-letter/${currentCoverLetter}`);
                const originalData = await response.json();
                if (!response.ok) {
                    saveStatus.textContent = '❌ Failed to get original cover letter data';
                    return;
                }
                const newResponse = await fetch('/create-cover-letter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_title: originalData.job_title,
                        company_name: originalData.company_name,
                        job_description: originalData.job_description,
                        generated_content: content
                    })
                });
                if (newResponse.ok) {
                    saveStatus.textContent = '✅ New cover letter created successfully!';
                    // Hide save options and switch to diff view
                    setTimeout(() => { 
                        document.getElementById('saveOptions').style.display = 'none';
                        switchRevisedTab('diff');
                    }, 1000);
                    loadCoverLetters();
                } else {
                    const result = await newResponse.json();
                    saveStatus.textContent = `❌ Failed to create new cover letter: ${result.detail}`;
                }
            } catch (error) {
                saveStatus.textContent = `❌ Failed to create new cover letter: ${error.message}`;
            }
        }

        // Selective deletion functions
        function toggleSelectAll(type) {
            let selector;
            if (type === 'documents') {
                selector = 'input[data-type="cv"], input[data-type="cover_letters"], input[data-type="cover_letter_docs"], input[data-type="other_documents"]';
            } else if (type === 'cv') {
                selector = 'input[data-type="cv"]';
            } else if (type === 'cover_letters') {
                selector = 'input[data-type="cover_letters"]';
            } else if (type === 'cover_letter_docs') {
                selector = 'input[data-type="cover_letter_docs"]';
            } else if (type === 'experiences') {
                selector = 'input[data-type="experiences"]';
            } else if (type === 'company_research') {
                selector = 'input[data-type="company_research"]';
            } else if (type === 'other_documents') {
                selector = 'input[data-type="other_documents"]';
            } else {
                selector = `input[data-type="${type}"]`;
            }
            // Map type to correct select all checkbox ID
            const selectAllIdMap = {
                'documents': 'selectAllDocuments',
                'cv': 'selectAllCV',
                'cover_letters': 'selectAllCoverLetters',
                'cover_letter_docs': 'selectAllCoverLetterDocs',
                'other_documents': 'selectAllOtherDocuments',
                'experiences': 'selectAllExperiences',
                'company_research': 'selectAllCompanyResearch'
            };
            const selectAllCheckbox = document.getElementById(selectAllIdMap[type] || `selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`);
            if (!selectAllCheckbox) return;
            document.querySelectorAll(selector).forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            // If toggling main documents, also uncheck all sub select-alls if unchecked
            if (type === 'documents' && !selectAllCheckbox.checked) {
                ['selectAllCV', 'selectAllCoverLetters', 'selectAllCoverLetterDocs', 'selectAllOtherDocuments'].forEach(subId => {
                    const subBox = document.getElementById(subId);
                    if (subBox) subBox.checked = false;
                });
            }
            updateSelectedCount();
        }

        function updateSelectedCount() {
            // Only count checked item checkboxes in the database list (not select all checkboxes)
            const selectedCheckboxes = document.querySelectorAll('.database-item input[type="checkbox"]:checked');
            const countElement = document.getElementById('selectedCount');
            countElement.textContent = `${selectedCheckboxes.length} items selected`;
        }

        async function deleteItem(type, id) {
            if (!confirm(`Are you sure you want to delete this ${type.replace('_', ' ')}?`)) {
                return;
            }

            try {
                const response = await fetch(`/delete-${type}/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showStatus(`✅ ${type.replace('_', ' ')} deleted successfully`, 'success');
                    checkDatabase(); // Refresh the database view
                } else {
                    const result = await response.json();
                    showStatus(`❌ Failed to delete: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Failed to delete: ${error.message}`, 'error');
            }
        }

        async function viewItem(type, id) {
            try {
                let endpoint = '';
                let title = '';
                
                switch (type) {
                    case 'document':
                        endpoint = `/document/${id}`;
                        title = 'Document Details';
                        break;
                    case 'cover_letter':
                        endpoint = `/cover-letter/${id}`;
                        title = 'Cover Letter Details';
                        break;
                    case 'experience':
                        endpoint = `/experience/${id}`;
                        title = 'Experience Details';
                        break;
                    case 'company_research':
                        endpoint = `/company-research/${id}`;
                        title = 'Company Research Details';
                        break;
                    default:
                        showStatus(`❌ Unknown item type: ${type}`, 'error');
                        return;
                }

                const response = await fetch(endpoint);
                if (!response.ok) {
                    const result = await response.json();
                    showStatus(`❌ Failed to load data: ${result.detail}`, 'error');
                    return;
                }

                const data = await response.json();
                showModal(title, data, type);
            } catch (error) {
                showStatus(`❌ Failed to load data: ${error.message}`, 'error');
            }
        }

        function showModal(title, data, type) {
            document.getElementById('modalTitle').textContent = title;
            const modalData = document.getElementById('modalData');
            
            let html = '';
            
            switch (type) {
                case 'document':
                    html = formatDocumentData(data);
                    break;
                case 'cover_letter':
                    html = formatCoverLetterData(data);
                    break;
                case 'experience':
                    html = formatExperienceData(data);
                    break;
                case 'company_research':
                    html = formatCompanyResearchData(data);
                    break;
                default:
                    html = formatGenericData(data);
            }
            
            modalData.innerHTML = html;
            document.getElementById('dataModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('dataModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('dataModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        function formatDocumentData(data) {
            return `
                <div class="data-section">
                    <h4>📄 Document Information</h4>
                    <div class="data-field">
                        <label>Filename:</label>
                        <div class="value">${data.filename || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Document Type:</label>
                        <div class="value">${data.document_type || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Uploaded At:</label>
                        <div class="value">${data.uploaded_at || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>File Path:</label>
                        <div class="value">${data.file_path || 'N/A'}</div>
                    </div>
                </div>
                <div class="data-section">
                    <h4>📝 Content Preview</h4>
                    <div class="data-field">
                        <label>Content (first 500 characters):</label>
                        <div class="value">${(data.content || 'No content').substring(0, 500)}${(data.content || '').length > 500 ? '...' : ''}</div>
                    </div>
                </div>
                <div class="data-section">
                    <h4>🔍 Parsed Data</h4>
                    <div class="data-field">
                        <label>Parsed Data:</label>
                        <div class="value json">${JSON.stringify(data.parsed_data || {}, null, 2)}</div>
                    </div>
                </div>
            `;
        }

        function formatCoverLetterData(data) {
            return `
                <div class="data-section">
                    <h4>📝 Cover Letter Information</h4>
                    <div class="data-field">
                        <label>Job Title:</label>
                        <div class="value">${data.job_title || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Company Name:</label>
                        <div class="value">${data.company_name || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Generated At:</label>
                        <div class="value">${data.generated_at || 'N/A'}</div>
                    </div>
                </div>
                <div class="data-section">
                    <h4>📄 Cover Letter Content</h4>
                    <div class="data-field">
                        <label>Generated Content:</label>
                        <div class="value">${data.generated_content || 'No content'}</div>
                    </div>
                </div>
                <div class="data-section">
                    <h4>🏢 Company Research Used</h4>
                    <div class="data-field">
                        <label>Company Research Data:</label>
                        <div class="value json">${JSON.stringify(data.company_research || {}, null, 2)}</div>
                    </div>
                </div>
            `;
        }

        function formatExperienceData(data) {
            return `
                <div class="data-section">
                    <h4>💼 Experience Information</h4>
                    <div class="data-field">
                        <label>Title:</label>
                        <div class="value">${data.title || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Company:</label>
                        <div class="value">${data.company || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Start Date:</label>
                        <div class="value">${data.start_date || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>End Date:</label>
                        <div class="value">${data.end_date || 'Present'}</div>
                    </div>
                    <div class="data-field">
                        <label>Description:</label>
                        <div class="value">${data.description || 'No description'}</div>
                    </div>
                    <div class="data-field">
                        <label>Skills:</label>
                        <div class="value">${(data.skills || []).join(', ') || 'No skills listed'}</div>
                    </div>
                    <div class="data-field">
                        <label>Location:</label>
                        <div class="value">${data.location || 'N/A'}</div>
                    </div>
                </div>
            `;
        }

        function formatCompanyResearchData(data) {
            return `
                <div class="data-section">
                    <h4>🏢 Company Research Information</h4>
                    <div class="data-field">
                        <label>Company Name:</label>
                        <div class="value">${data.company_name || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Researched At:</label>
                        <div class="value">${data.researched_at || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Website:</label>
                        <div class="value">${data.website || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Industry:</label>
                        <div class="value">${data.industry || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Size:</label>
                        <div class="value">${data.size || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Location:</label>
                        <div class="value">${data.location || 'N/A'}</div>
                    </div>
                    <div class="data-field">
                        <label>Description:</label>
                        <div class="value">${data.description || 'No description'}</div>
                    </div>
                </div>
                <div class="data-section">
                    <h4>🔍 Detailed Research Data</h4>
                    <div class="data-field">
                        <label>Complete Research Data:</label>
                        <div class="value json">${JSON.stringify(data.research_data || {}, null, 2)}</div>
                    </div>
                </div>
            `;
        }

        function formatGenericData(data) {
            return `
                <div class="data-section">
                    <h4>📊 Data Details</h4>
                    <div class="data-field">
                        <label>Raw Data:</label>
                        <div class="value json">${JSON.stringify(data, null, 2)}</div>
                    </div>
                </div>
            `;
        }

        async function deleteSelectedItems() {
            const selectedCheckboxes = document.querySelectorAll('input[type="checkbox"]:checked:not([id^="selectAll"])');
            
            if (selectedCheckboxes.length === 0) {
                showStatus('❌ No items selected for deletion', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedCheckboxes.length} selected items?`)) {
                return;
            }

            let deletedCount = 0;
            let errorCount = 0;
            let failedItems = [];

            for (const checkbox of selectedCheckboxes) {
                let type = checkbox.getAttribute('data-type');
                const id = checkbox.value;
                // Ignore checkboxes with value 'on' or non-numeric IDs
                if (!id || id === 'on' || isNaN(Number(id))) continue;
                // Robust mapping for all types to backend endpoints
                const typeMap = {
                    'cv': 'document',
                    'cover_letter_docs': 'document',
                    'other_documents': 'document',
                    'cover_letters': 'cover_letter',
                    'experiences': 'experience',
                    'company_research': 'company_research'
                };
                const endpointType = typeMap[type] || type;
                try {
                    const response = await fetch(`/delete-${endpointType}/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        deletedCount++;
                    } else {
                        errorCount++;
                        failedItems.push(`${type} (ID: ${id})`);
                    }
                } catch (error) {
                    errorCount++;
                    failedItems.push(`${type} (ID: ${id})`);
                }
            }

            if (deletedCount > 0) {
                let msg = `✅ Successfully deleted ${deletedCount} item${deletedCount > 1 ? 's' : ''}`;
                if (errorCount > 0) {
                    msg += `. Failed to delete: ${failedItems.join(', ')}`;
                }
                showStatus(msg, errorCount > 0 ? 'error' : 'success');
                checkDatabase(); // Refresh the database view
            } else {
                showStatus(`❌ Failed to delete any items`, 'error');
            }
        }

        // Add event listeners for checkboxes
        document.addEventListener('change', function(e) {
            if (e.target.type === 'checkbox' && !e.target.id.startsWith('selectAll')) {
                updateSelectedCount();
            }
        });

        // Collapsible section functionality
        function toggleSection(sectionId) {
            const header = document.querySelector(`[onclick="toggleSection('${sectionId}')"]`);
            const content = document.getElementById(`content-${sectionId}`);
            const toggleIcon = header.querySelector('.toggle-icon');
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
                if (toggleIcon) toggleIcon.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
                if (toggleIcon) toggleIcon.classList.add('collapsed');
            }
        }

        // Search and filter functionality
        function filterDatabaseItems() {
            const searchTerm = document.getElementById('databaseSearch').value.toLowerCase();
            const filterType = document.getElementById('databaseFilter').value;
            const items = document.querySelectorAll('.database-item');
            
            items.forEach(item => {
                const itemType = item.getAttribute('data-type');
                const itemTitle = item.getAttribute('data-title') || '';
                const itemContent = item.getAttribute('data-content') || '';
                
                let showByType = true;
                if (filterType !== 'all') {
                    showByType = itemType === filterType || 
                                (filterType === 'cv' && itemType === 'cv') ||
                                (filterType === 'cover_letters' && itemType === 'cover_letters') ||
                                (filterType === 'cover_letter_docs' && itemType === 'cover_letter_docs') ||
                                (filterType === 'other' && itemType === 'other_documents') ||
                                (filterType === 'experience' && itemType === 'experiences') ||
                                (filterType === 'company_research' && itemType === 'company_research');
                }
                
                const showBySearch = searchTerm === '' || 
                                   itemTitle.includes(searchTerm) || 
                                   itemContent.includes(searchTerm);
                
                if (showByType && showBySearch) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Update section visibility based on visible items
            updateSectionVisibility();
        }

        function updateSectionVisibility() {
            const sections = ['cv', 'cover_letters', 'cover_letter_docs', 'other_documents', 'experiences', 'company_research'];
            
            sections.forEach(sectionId => {
                const content = document.getElementById(`content-${sectionId}`);
                if (content) {
                    const visibleItems = content.querySelectorAll('.database-item[style="display: flex;"]');
                    const section = content.closest('.collapsible-section');
                    
                    if (visibleItems.length === 0) {
                        section.style.display = 'none';
                    } else {
                        section.style.display = 'block';
                    }
                }
            });
        }

        // View mode functionality
        function toggleViewMode(mode) {
            const items = document.querySelectorAll('.database-item');
            const normalBtn = document.getElementById('viewNormal');
            const compactBtn = document.getElementById('viewCompact');
            
            if (mode === 'compact') {
                items.forEach(item => item.classList.add('compact'));
                normalBtn.classList.remove('active');
                compactBtn.classList.add('active');
            } else {
                items.forEach(item => item.classList.remove('compact'));
                normalBtn.classList.add('active');
                compactBtn.classList.remove('active');
            }
        }

        // Diff comparison functionality
        let diffMode = false;
        let originalContent = '';
        let currentContent = '';

        function showDiff() {
            const currentText = document.getElementById('currentCoverLetterContent').textContent;
            const revisedText = document.getElementById('revisedDiffContent').textContent;
            
            // Normalize line endings for comparison but preserve all whitespace
            const normalizedCurrent = currentText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const normalizedRevised = revisedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            if (normalizedCurrent === normalizedRevised) {
                // No changes - show the content normally with proper formatting
                document.getElementById('noChangesMessage').style.display = 'none';
                document.getElementById('revisedDiffContent').style.display = 'block';
                document.getElementById('revisedDiffContent').textContent = revisedText;
                document.getElementById('diffStatus').textContent = 'No changes detected';
            } else {
                // Changes detected - show the revised content with proper formatting
                document.getElementById('noChangesMessage').style.display = 'none';
                document.getElementById('revisedDiffContent').style.display = 'block';
                document.getElementById('revisedDiffContent').textContent = revisedText;
                document.getElementById('diffStatus').textContent = 'Changes detected';
            }
        }

        function generateDiff(original, revised) {
            // Simple word-by-word diff implementation
            const originalWords = original.split(/\s+/);
            const revisedWords = revised.split(/\s+/);
            
            let diffHtml = '';
            let i = 0, j = 0;
            
            while (i < originalWords.length || j < revisedWords.length) {
                if (i < originalWords.length && j < revisedWords.length && originalWords[i] === revisedWords[j]) {
                    // Words match
                    diffHtml += originalWords[i] + ' ';
                    i++;
                    j++;
                } else {
                    // Words don't match - find the longest common subsequence
                    let found = false;
                    
                    // Look ahead in revised text
                    for (let k = j + 1; k < Math.min(j + 5, revisedWords.length); k++) {
                        if (i < originalWords.length && originalWords[i] === revisedWords[k]) {
                            // Add removed words from original
                            for (let m = j; m < k; m++) {
                                diffHtml += `<span class="diff-added">${revisedWords[m]}</span> `;
                            }
                            j = k;
                            found = true;
                            break;
                        }
                    }
                    
                    // Look ahead in original text
                    if (!found) {
                        for (let k = i + 1; k < Math.min(i + 5, originalWords.length); k++) {
                            if (j < revisedWords.length && originalWords[k] === revisedWords[j]) {
                                // Add removed words from original
                                for (let m = i; m < k; m++) {
                                    diffHtml += `<span class="diff-removed">${originalWords[m]}</span> `;
                                }
                                i = k;
                                found = true;
                                break;
                            }
                        }
                    }
                    
                    // If no match found, mark as changed
                    if (!found) {
                        if (i < originalWords.length) {
                            diffHtml += `<span class="diff-removed">${originalWords[i]}</span> `;
                            i++;
                        }
                        if (j < revisedWords.length) {
                            diffHtml += `<span class="diff-added">${revisedWords[j]}</span> `;
                            j++;
                        }
                    }
                }
            }
            
            return diffHtml;
        }

        function countChanges(diffHtml) {
            const addedMatches = diffHtml.match(/class="diff-added"/g);
            const removedMatches = diffHtml.match(/class="diff-removed"/g);
            const addedCount = addedMatches ? addedMatches.length : 0;
            const removedCount = removedMatches ? removedMatches.length : 0;
            return addedCount + removedCount;
        }

        function updateDiffStatus() {
            const currentText = document.getElementById('currentCoverLetterContent').textContent;
            const revisedText = document.getElementById('revisedDiffContent').textContent;
            
            // Normalize line endings for comparison but preserve all whitespace
            const normalizedCurrent = currentText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const normalizedRevised = revisedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            if (normalizedCurrent === normalizedRevised) {
                // No changes - show the content normally with proper formatting
                document.getElementById('noChangesMessage').style.display = 'none';
                document.getElementById('revisedDiffContent').style.display = 'block';
                document.getElementById('revisedDiffContent').textContent = revisedText;
                document.getElementById('diffStatus').textContent = 'No changes detected';
            } else {
                // Changes detected - show the revised content with proper formatting
                document.getElementById('noChangesMessage').style.display = 'none';
                document.getElementById('revisedDiffContent').style.display = 'block';
                document.getElementById('revisedDiffContent').textContent = revisedText;
                document.getElementById('diffStatus').textContent = 'Changes detected';
            }
        }

        async function batchGenerateCoverLetters() {
            const websitesRaw = document.getElementById('batchWebsites').value.trim();
            const jobTitle = document.getElementById('batchJobTitle').value.trim();
            const companyName = document.getElementById('batchCompanyName').value.trim();
            const jobDescription = document.getElementById('batchJobDescription').value.trim();
            const tone = document.getElementById('batchTone').value;
            const delay = parseInt(document.getElementById('batchDelay').value) || 3;
            const includeCompanyResearch = document.getElementById('batchIncludeCompanyResearch').checked;
            const researchProvider = document.getElementById('batchResearchProvider').value;
            const researchCountry = document.getElementById('batchResearchCountry').value;
            const batchLlmProvider = document.getElementById('batchLlmProvider').value;
            const batchLlmModel = document.getElementById('batchLlmModel').value;
            const batchStrictRelevance = document.getElementById('batchStrictRelevance').checked;
            
            if (!websitesRaw) {
                showStatus('❌ Please enter at least one job ad URL', 'error', 'batchStatus');
                return;
            }
            const websites = websitesRaw.split(/\n|,/).map(s => s.trim()).filter(Boolean);
            showStatus(`Batch generating cover letters with ${delay}s delay between jobs...`, 'info', 'batchStatus');
            try {
                const response = await fetch('/batch-cover-letters', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_title: jobTitle,
                        companies: [],
                        job_description: jobDescription,
                        tone: tone,
                        websites: websites,
                        delay_seconds: delay,
                        include_company_research: includeCompanyResearch,
                        research_provider: researchProvider || null,
                        research_country: researchCountry || null,
                        llm_provider: batchLlmProvider || null,
                        llm_model: batchLlmModel || null,
                        strict_relevance: batchStrictRelevance
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    let html = `<div class='status success'><h4>Batch Results</h4><ul>`;
                    result.results.forEach(r => {
                        if (r.status === 'success') {
                            html += `<li>✅ <b>${r.company || 'Unknown Company'}</b> (${r.job_title || ''}) from <a href='${r.website}' target='_blank'>${r.website || 'N/A'}</a> - <b>Success</b></li>`;
                        } else {
                            let errMsg = r.error;
                            if (typeof errMsg === 'object') {
                                console.error('Batch error object:', errMsg);
                                errMsg = errMsg.error || JSON.stringify(errMsg);
                            }
                            html += `<li>❌ <b>${r.company || 'Unknown'}</b> from <a href='${r.website}' target='_blank'>${r.website || 'N/A'}</a> - <b>Error:</b> ${errMsg}</li>`;
                        }
                    });
                    html += `</ul><p>Total: ${result.total_processed}, Success: ${result.successful}, Failed: ${result.failed}</p></div>`;
                    document.getElementById('batchStatus').innerHTML = html;
                    checkDatabase();
                } else {
                    showStatus(`❌ Error: ${result.detail}`, 'error', 'batchStatus');
                }
            } catch (error) {
                showStatus(`❌ Batch generation failed: ${error.message}`, 'error', 'batchStatus');
            }
        }

        // Utility: Sanitize contenteditable HTML to plain text
        function sanitizeEditableContent(html) {
            // Replace <br> and <div> with \n, strip all other tags
            let text = html.replace(/<div><br><\/div>/g, '\n')
                           .replace(/<div>/g, '\n')
                           .replace(/<br>/g, '\n')
                           .replace(/<\/div>/g, '')
                           .replace(/<[^>]+>/g, '');
            // Remove leading/trailing whitespace and normalize newlines
            text = text.replace(/\n{2,}/g, '\n').trim();
            return text;
        }

        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.textContent = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function exportCurrentLetter(format) {
            if (!currentCoverLetter) {
                showStatus('Please select a cover letter first!', 'error');
                return;
            }
            await exportCoverLetter(currentCoverLetter, format);
        }

        // Save popup logic: ensure chat controls are always visible
        function showSaveOptions() {
            document.getElementById('saveOptions').style.display = 'block';
            document.querySelector('.chat-main').classList.add('save-popup-active');
        }
        function hideSaveOptions() {
            document.getElementById('saveOptions').style.display = 'none';
            document.querySelector('.chat-main').classList.remove('save-popup-active');
        }
        // Replace any code that shows/hides #saveOptions with showSaveOptions()/hideSaveOptions()
        // Example usage:
        // showSaveOptions(); // when unsaved changes detected
        // hideSaveOptions(); // when changes are saved or cancelled

        // Add this at the top of your <script> section
        let chatProviderModelSelections = {};

        // Patch the chat model dropdown to remember selection
        // Add this event listener after chatLlmModel is created
        // (You can add this after loadChatLLMModels definition)
        document.getElementById('chatLlmModel').addEventListener('change', function() {
            const provider = document.getElementById('chatLlmProvider').value;
            chatProviderModelSelections[provider] = this.value;
        });

        // Show/hide Vision LLM provider/model based on logo recognition selection
        document.getElementById('logoRecognition').addEventListener('change', function() {
            const value = this.value;
            const providerGroup = document.getElementById('visionLLMProviderGroup');
            const modelGroup = document.getElementById('visionLLMModelGroup');
            if (value === 'vision_llm') {
                providerGroup.style.display = 'block';
                modelGroup.style.display = 'block';
            } else {
                providerGroup.style.display = 'none';
                modelGroup.style.display = 'none';
            }
        });

        async function showFullData(docId) {
            const fullDataDiv = document.getElementById(`fullData-${docId}`);
            if (fullDataDiv.style.display === 'none') {
                // Fetch full parsed data from backend
                const resp = await fetch(`/document/${docId}`);
                const data = await resp.json();
                fullDataDiv.textContent = JSON.stringify(data, null, 2);
                fullDataDiv.style.display = 'block';
            } else {
                fullDataDiv.style.display = 'none';
            }
        }

        async function updateVisionLlmModels() {
            const provider = document.getElementById('visionLlmProvider').value;
            const modelSelect = document.getElementById('visionLlmModel');
            modelSelect.innerHTML = '<option>Loading...</option>';
            try {
                const response = await fetch(`/llm-models/${provider}`);
                const data = await response.json();
                modelSelect.innerHTML = '';
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const opt = document.createElement('option');
                        opt.value = model;
                        opt.textContent = model;
                        modelSelect.appendChild(opt);
                    });
                    // Set default model if available
                    if (data.current_model && data.models.includes(data.current_model)) {
                        modelSelect.value = data.current_model;
                    }
                } else {
                    const opt = document.createElement('option');
                    opt.value = '';
                    opt.textContent = 'No models available';
                    modelSelect.appendChild(opt);
                }
            } catch (error) {
                modelSelect.innerHTML = '<option>Error loading models</option>';
            }
        }
        // Initialize models on page load
        updateVisionLlmModels();

        function toggleVisionLlmOptions() {
            const enabled = document.getElementById('enableVisionLlm').checked;
            document.getElementById('visionLlmProviderGroup').style.display = enabled ? 'block' : 'none';
            document.getElementById('visionLlmModelGroup').style.display = enabled ? 'block' : 'none';
            document.getElementById('logoRecognition').value = enabled ? 'vision_llm' : 'none';
            if (enabled) {
                document.getElementById('visionLlmProvider').value = 'ollama';
                updateVisionLlmModels();
            }
        }
        // ... existing code ...
        // Optionally, initialize the checkbox state on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('enableVisionLlm').checked = false;
            toggleVisionLlmOptions();
        });

        function updateDebugPanel() {
            const debugPanel = document.getElementById('debugPanel');
            const uploadBtn = document.getElementById('uploadBtn');
            if (!debugPanel || !uploadBtn) return;
            debugPanel.innerHTML =
                `<b>selectedFiles:</b> ${JSON.stringify(selectedFiles.map(f => f.name))}<br>` +
                `<b>Upload Button Disabled:</b> ${uploadBtn.disabled}`;
            debugPanel.style.display = 'block';
        }
        // Patch addFiles, removeFile, updateFileList to call updateDebugPanel
        const _addFiles = addFiles;
        addFiles = function(files) { _addFiles(files); updateDebugPanel(); };
        const _removeFile = removeFile;
        removeFile = function(index) { _removeFile(index); updateDebugPanel(); };
        const _updateFileList = updateFileList;
        updateFileList = function() { _updateFileList(); updateDebugPanel(); };
        // Also update on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', updateDebugPanel);

        function clearFileSelection() {
            selectedFiles = [];
            updateFileList();
            document.getElementById('fileInput').value = '';
        }

        // Add a standalone LinkedIn profile import (no file)
        document.addEventListener('DOMContentLoaded', function() {
            const uploadTab = document.getElementById('upload-tab');
            if (uploadTab) {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = 'Add LinkedIn Profile (No File)';
                btn.onclick = showLinkedInProfileModal;
                uploadTab.insertBefore(btn, uploadTab.firstChild.nextSibling);
            }
        });

        function showLinkedInProfileModal() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Add LinkedIn Profile</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <label>LinkedIn Profile URL:</label>
                        <input type="text" id="standaloneLinkedinUrl" style="width:100%;margin-bottom:10px;">
                        <label>Email:</label>
                        <input type="text" id="standaloneLinkedinEmail" style="width:100%;margin-bottom:10px;">
                        <label>Password:</label>
                        <input type="password" id="standaloneLinkedinPassword" style="width:100%;margin-bottom:10px;">
                        <button class="btn" onclick="submitStandaloneLinkedinProfile(this)">Import LinkedIn Profile</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function submitStandaloneLinkedinProfile(btn) {
            const modal = btn.closest('.modal');
            const url = document.getElementById('standaloneLinkedinUrl').value.trim();
            const email = document.getElementById('standaloneLinkedinEmail').value.trim();
            const password = document.getElementById('standaloneLinkedinPassword').value;
            if (!url || !email || !password) {
                alert('Please provide LinkedIn URL, email, and password.');
                return;
            }
            btn.disabled = true;
            btn.textContent = 'Importing...';
            try {
                const formData = new FormData();
                formData.append('email', email);
                formData.append('password', password);
                formData.append('profile_url', url);
                const response = await fetch('/import-linkedin', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (response.ok) {
                    alert('LinkedIn profile imported successfully!');
                    checkDatabase();
                    modal.remove();
                } else {
                    alert('Error: ' + (result.detail || 'Failed to import LinkedIn profile.'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Import LinkedIn Profile';
            }
        }

        // --- File type bulk set logic ---
        function setAllFileTypes(type) {
            // Set all type dropdowns to the given type
            selectedFiles.forEach((file, index) => {
                const typeSelect = document.getElementById(`type-${index}`);
                if (typeSelect) {
                    typeSelect.value = type;
                    // Trigger change event to update LinkedIn URL input visibility
                    handleTypeChange(index);
                }
            });
        }

        function showGenerationTab(tab) {
            document.getElementById('singleGenTab').classList.remove('active');
            document.getElementById('batchGenTab').classList.remove('active');
            document.getElementById('singleGenerationForm').classList.remove('active');
            document.getElementById('batchGenerationForm').classList.remove('active');
            if (tab === 'single') {
                document.getElementById('singleGenTab').classList.add('active');
                document.getElementById('singleGenerationForm').classList.add('active');
            } else {
                document.getElementById('batchGenTab').classList.add('active');
                document.getElementById('batchGenerationForm').classList.add('active');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            // Ensure only the single generation form is visible by default
            showGenerationTab('single');
            // ... existing code ...
        });

        // Document weight management functions
        async function updateDocumentWeight(documentId, newWeight) {
            try {
                const weight = parseFloat(newWeight);
                if (weight <= 0) {
                    alert('Weight must be positive');
                    return;
                }
                
                const response = await fetch(`/documents/${documentId}/weight`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ manual_weight: weight })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus(`✅ Updated weight for ${result.filename} to ${result.new_manual_weight}x`, 'success');
                    // Update the display
                    const weightSpan = document.querySelector(`#weight-${documentId}`).parentNode.querySelector('span');
                    if (weightSpan) {
                        weightSpan.textContent = `Current: ${result.new_manual_weight}x`;
                    }
                } else {
                    showStatus(`❌ Failed to update weight: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus(`❌ Error updating weight: ${error.message}`, 'error');
            }
        }
        
        async function getDocumentWeightInfo(documentId) {
            try {
                const response = await fetch(`/documents/${documentId}/weight`);
                const result = await response.json();
                
                if (response.ok) {
                    const info = result.weight_info;
                    alert(`📊 Weight Info: ${result.filename}

🎯 Current Settings:
• Manual Weight: ${info.manual_weight}x
• Document Type: ${result.document_type} (${info.type_weight}x)
• Final Weight: ${info.final_calculated_weight.toFixed(2)}x

💡 Weight Guidelines:
• 🔥 Exceptional (got you a job): 3.0x - 5.0x
• ⭐ High quality examples: 2.0x - 3.0x  
• 📈 Important documents: 1.5x - 2.0x
• ⚖️ Normal weight: 1.0x
• 📉 Less relevant: 0.5x - 0.8x

Formula: Base × Type × Recency × Manual`);
                } else {
                    alert(`❌ Failed to get weight info: ${result.detail}`);
                }
            } catch (error) {
                alert(`❌ Error getting weight info: ${error.message}`);
            }
        }

        // On page load, ensure correct visibility
        showTab('generate');
    </script>
</body>
</html> 

