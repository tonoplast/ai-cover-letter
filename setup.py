#!/usr/bin/env python3
"""
AI Cover Letter Generator - Setup Script
Helps users configure the environment and get started.
"""

import os
import sys
import shutil
import secrets
from pathlib import Path

def print_banner():
    print("=" * 60)
    print("ðŸ¤– AI Cover Letter Generator - Setup")
    print("=" * 60)

def check_python_version():
    """Check if Python version is compatible"""
    if sys.version_info < (3, 8):
        print("âŒ Python 3.8 or higher is required")
        sys.exit(1)
    print(f"âœ… Python {sys.version_info.major}.{sys.version_info.minor} detected")

def create_env_file():
    """Create .env file from template"""
    template_path = Path("env.template")
    env_path = Path(".env")
    
    if env_path.exists():
        response = input("ðŸ“„ .env file already exists. Overwrite? (y/N): ")
        if response.lower() != 'y':
            print("â­ï¸  Skipping .env creation")
            return
    
    if not template_path.exists():
        print("âŒ env.template not found. Creating basic .env file...")
        create_basic_env()
        return
    
    try:
        shutil.copy(template_path, env_path)
        print("âœ… Created .env file from template")
        print("ðŸ“ Please edit .env file with your configuration")
    except Exception as e:
        print(f"âŒ Failed to create .env file: {e}")
        create_basic_env()

def create_basic_env():
    """Create a basic .env file"""
    secret_key = secrets.token_urlsafe(32)
    env_content = f"""# AI Cover Letter Generator - Basic Configuration
# Generated by setup script

# LLM Configuration (Ollama - local)
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama3.2:latest

# Security
SECRET_KEY={secret_key}

# Development
DEBUG=True

# Database
DATABASE_URL=sqlite:///./ai_cover_letter.db

# Optional: Add API keys for company research
# TAVILY_API_KEY=your_tavily_api_key_here
# GOOGLE_API_KEY=your_google_api_key_here
# BRAVE_API_KEY=your_brave_api_key_here
"""
    
    try:
        with open(".env", "w") as f:
            f.write(env_content)
        print("âœ… Created basic .env file")
    except Exception as e:
        print(f"âŒ Failed to create .env file: {e}")

def check_ollama():
    """Check if Ollama is available"""
    try:
        import requests
        response = requests.get("http://localhost:11434/api/tags", timeout=5)
        if response.status_code == 200:
            print("âœ… Ollama is running")
            return True
        else:
            print("âš ï¸  Ollama is running but may not be responding correctly")
            return False
    except Exception:
        print("âŒ Ollama is not running")
        print("ðŸ’¡ To install Ollama:")
        print("   - Visit: https://ollama.ai/")
        print("   - Or run: curl -fsSL https://ollama.ai/install.sh | sh")
        print("   - Then run: ollama pull llama3.2:latest")
        return False

def check_dependencies():
    """Check if required dependencies are installed"""
    required_packages = [
        "fastapi", "uvicorn", "sqlalchemy", "pydantic",
        "python-multipart", "python-dotenv", "requests"
    ]
    
    missing_packages = []
    for package in required_packages:
        try:
            __import__(package.replace("-", "_"))
        except ImportError:
            missing_packages.append(package)
    
    if missing_packages:
        print(f"âŒ Missing packages: {', '.join(missing_packages)}")
        print("ðŸ’¡ Install with: pip install -r requirements.txt")
        return False
    else:
        print("âœ… All required packages are installed")
        return True

def create_directories():
    """Create necessary directories"""
    directories = ["uploads", "logs", "exports"]
    
    for directory in directories:
        Path(directory).mkdir(exist_ok=True)
    
    print("âœ… Created necessary directories")

def run_migrations():
    """Run database migrations"""
    try:
        import subprocess
        result = subprocess.run(["alembic", "upgrade", "head"], 
                              capture_output=True, text=True)
        if result.returncode == 0:
            print("âœ… Database migrations completed")
        else:
            print(f"âš ï¸  Migration warning: {result.stderr}")
    except Exception as e:
        print(f"âš ï¸  Could not run migrations: {e}")
        print("ðŸ’¡ You can run migrations manually with: alembic upgrade head")

def print_next_steps():
    """Print next steps for the user"""
    print("\n" + "=" * 60)
    print("ðŸŽ‰ Setup Complete!")
    print("=" * 60)
    print("\nðŸ“‹ Next Steps:")
    print("1. Edit .env file with your configuration")
    print("2. Start Ollama: ollama serve")
    print("3. Pull model: ollama pull llama3.2:latest")
    print("4. Run the application: uvicorn app.main:app --reload")
    print("5. Open browser: http://localhost:8000")
    print("\nðŸ”§ Optional Enhancements:")
    print("- Get Tavily API key for company research: https://tavily.com/")
    print("- Get Brave Search API key: https://api.search.brave.com/")
    print("- Install self-hosted search engines (YaCy, SearXNG)")
    print("\nðŸ“š Documentation:")
    print("- README.md for detailed usage instructions")
    print("- env.template for all configuration options")

def main():
    print_banner()
    
    print("\nðŸ” Checking system requirements...")
    check_python_version()
    
    print("\nðŸ“¦ Checking dependencies...")
    deps_ok = check_dependencies()
    
    print("\nðŸ¤– Checking Ollama...")
    ollama_ok = check_ollama()
    
    print("\nðŸ“ Creating directories...")
    create_directories()
    
    print("\nðŸ“„ Creating environment file...")
    create_env_file()
    
    print("\nðŸ—„ï¸  Running database migrations...")
    run_migrations()
    
    print_next_steps()
    
    if not deps_ok:
        print("\nâš ï¸  Some dependencies are missing. Please install them before running the application.")
    
    if not ollama_ok:
        print("\nâš ï¸  Ollama is not running. Please start it before running the application.")

if __name__ == "__main__":
    main() 